-- Chat Logger GUI (with player filtering)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.5
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
header.Parent = mainFrame

-- ðŸ”½ Title Dropdown
local titleBtn = Instance.new("TextButton")
titleBtn.Size = UDim2.new(1, -140, 1, 0)
titleBtn.Position = UDim2.new(0, 8, 0, 0)
titleBtn.BackgroundTransparency = 1
titleBtn.Text = "Chat Logger â–¼"
titleBtn.TextColor3 = Color3.fromRGB(220, 220, 220)
titleBtn.Font = Enum.Font.SourceSansBold
titleBtn.TextSize = 16
titleBtn.TextXAlignment = Enum.TextXAlignment.Left
titleBtn.Parent = header

-- Dropdown container
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(1, -20, 0, 160)
dropdownFrame.Position = UDim2.new(0, 10, 0, 30)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dropdownFrame.Visible = false
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Parent = mainFrame
Instance.new("UICorner", dropdownFrame).CornerRadius = UDim.new(0, 6)

local dropdownScroll = Instance.new("ScrollingFrame")
dropdownScroll.Size = UDim2.new(1, 0, 1, 0)
dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdownScroll.ScrollBarThickness = 6
dropdownScroll.BackgroundTransparency = 1
dropdownScroll.Parent = dropdownFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 2)
listLayout.SortOrder = Enum.SortOrder.Name
listLayout.Parent = dropdownScroll

-- Filter state
local selectedPlayers = {}

local function updateDropdown()
	for _, child in ipairs(dropdownScroll:GetChildren()) do
		if child:IsA("TextButton") then child:Destroy() end
	end

	for _, plr in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -6, 0, 22)
		btn.BackgroundColor3 = selectedPlayers[plr.Name] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(60, 60, 60)
		btn.TextColor3 = Color3.fromRGB(255, 255, 255)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 14
		btn.Text = plr.DisplayName .. " (@" .. plr.Name .. ")"
		btn.Parent = dropdownScroll
		btn.BorderSizePixel = 0
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)

		btn.MouseButton1Click:Connect(function()
			selectedPlayers[plr.Name] = not selectedPlayers[plr.Name]
			btn.BackgroundColor3 = selectedPlayers[plr.Name] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(60, 60, 60)
		end)
	end

	dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
end

Players.PlayerAdded:Connect(updateDropdown)
Players.PlayerRemoving:Connect(updateDropdown)

titleBtn.MouseButton1Click:Connect(function()
	dropdownFrame.Visible = not dropdownFrame.Visible
	titleBtn.Text = dropdownFrame.Visible and "Chat Logger â–²" or "Chat Logger â–¼"
	updateDropdown()
end)

-- ðŸ§­ Rest of UI (return, hide, spectate, scroll, etc.)
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 24, 0, 24)
returnBtn.Position = UDim2.new(1, -60, 0, 2)
returnBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
returnBtn.BorderSizePixel = 0
returnBtn.Text = "âŸ³"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 18
returnBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
returnBtn.Parent = header
Instance.new("UICorner", returnBtn).CornerRadius = UDim.new(0, 6)

local spectateLabel = Instance.new("TextLabel")
spectateLabel.Size = UDim2.new(0, 160, 0, 20)
spectateLabel.Position = UDim2.new(0, 110, 0, 4)
spectateLabel.BackgroundTransparency = 1
spectateLabel.Font = Enum.Font.SourceSansItalic
spectateLabel.TextSize = 14
spectateLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
spectateLabel.Text = ""
spectateLabel.TextXAlignment = Enum.TextXAlignment.Left
spectateLabel.Parent = header

local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 20, 0, 20)
hideBtn.Position = UDim2.new(1, -24, 0, 4)
hideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
hideBtn.BorderSizePixel = 0
hideBtn.Text = "v"
hideBtn.Font = Enum.Font.SourceSansBold
hideBtn.TextSize = 14
hideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
hideBtn.Parent = header
Instance.new("UICorner", hideBtn).CornerRadius = UDim.new(0, 6)

local unhideBtn = Instance.new("TextButton")
unhideBtn.Size = UDim2.new(0, 30, 0, 30)
unhideBtn.Position = UDim2.new(0, 10, 0, 10)
unhideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
unhideBtn.BorderSizePixel = 0
unhideBtn.Text = "^"
unhideBtn.Font = Enum.Font.SourceSansBold
unhideBtn.TextSize = 18
unhideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
unhideBtn.Visible = false
unhideBtn.Active = true
unhideBtn.Draggable = true
unhideBtn.Parent = screenGui
Instance.new("UICorner", unhideBtn).CornerRadius = UDim.new(0, 6)

hideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
	unhideBtn.Visible = true
end)
unhideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = true
	unhideBtn.Visible = false
end)

-- ðŸ“œ ScrollFrame for logs
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
scrollFrame.BackgroundTransparency = 0.5
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame
Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = scrollFrame

-- ðŸ•“ Timestamp + log + filter logic
local function formatTimestampUTCplus8()
	local now = os.time()
	local utc8 = os.date("!*t", now + 8 * 3600)
	local hour, min = utc8.hour, utc8.min
	local ampm = (hour >= 12) and "PM" or "AM"
	if hour == 0 then hour = 12 elseif hour > 12 then hour = hour - 12 end
	return string.format("%d:%02d%s", hour, min, ampm)
end

local function hashString(s)
	local h = 0
	for i = 1, #s do h = (h * 31 + string.byte(s, i)) % 0xFFFFFFFF end
	return h
end

local function hslToRgb(h, s, l)
	local function hue2rgb(p, q, t)
		if t < 0 then t += 1 end
		if t > 1 then t -= 1 end
		if t < 1/6 then return p + (q - p) * 6 * t end
		if t < 1/2 then return q end
		if t < 2/3 then return p + (q - p) * (2/3 - t) * 6 end
		return p
	end
	local q = l < 0.5 and l * (1 + s) or l + s - l * s
	local p = 2 * l - q
	return Color3.new(hue2rgb(p, q, h + 1/3), hue2rgb(p, q, h), hue2rgb(p, q, h - 1/3))
end

local usernameColorCache = {}
local function getColorForName(name)
	if usernameColorCache[name] then return usernameColorCache[name] end
	local hue = (hashString(name) % 360) / 360
	local color = hslToRgb(hue, 0.55, 0.55)
	usernameColorCache[name] = color
	return color
end

local function logMessage(text, displayName, username)
	-- ðŸ” Filter check
	if next(selectedPlayers) ~= nil and not selectedPlayers[username] then
		return
	end

	local entry = Instance.new("Frame")
	entry.Size = UDim2.new(1, -10, 0, 0)
	entry.BackgroundTransparency = 1
	entry.AutomaticSize = Enum.AutomaticSize.Y
	entry.Parent = scrollFrame

	local tsLabel = Instance.new("TextLabel", entry)
	tsLabel.Size = UDim2.new(0, 50, 0, 18)
	tsLabel.BackgroundTransparency = 1
	tsLabel.Font = Enum.Font.Code
	tsLabel.TextSize = 14
	tsLabel.Text = formatTimestampUTCplus8()
	tsLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
	tsLabel.TextXAlignment = Enum.TextXAlignment.Left

	local nameLabel = Instance.new("TextLabel", entry)
	nameLabel.Size = UDim2.new(0, 120, 0, 0)
	nameLabel.Position = UDim2.new(0, 54, 0, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 18
	nameLabel.Text = displayName
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.TextColor3 = getColorForName(username)
	nameLabel.AutomaticSize = Enum.AutomaticSize.Y

	local msgLabel = Instance.new("TextLabel", entry)
	msgLabel.Size = UDim2.new(1, -180, 0, 0)
	msgLabel.Position = UDim2.new(0, 174, 0, 0)
	msgLabel.BackgroundTransparency = 1
	msgLabel.Font = Enum.Font.SourceSans
	msgLabel.TextSize = 18
	msgLabel.TextWrapped = true
	msgLabel.TextXAlignment = Enum.TextXAlignment.Left
	msgLabel.AutomaticSize = Enum.AutomaticSize.Y
	msgLabel.Text = text
	msgLabel.TextColor3 = Color3.fromRGB(220, 220, 220)

	task.defer(function()
		scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
	end)
end

-- ðŸ“¡ Chat hook
if TextChatService.MessageReceived then
	TextChatService.MessageReceived:Connect(function(message)
		if message.Text and message.TextSource then
			local userId = message.TextSource.UserId
			local displayName, username = "[Unknown]", "[Unknown]"
			if userId then
				local p = Players:GetPlayerByUserId(userId)
				if p then
					displayName = p.DisplayName
					username = p.Name
				end
			end
			logMessage(message.Text, displayName, username)
		end
	end)
else
	for _, p in ipairs(Players:GetPlayers()) do
		p.Chatted:Connect(function(msg)
			logMessage(msg, p.DisplayName, p.Name)
		end)
	end
	Players.PlayerAdded:Connect(function(p)
		p.Chatted:Connect(function(msg)
			logMessage(msg, p.DisplayName, p.Name)
		end)
	end)
end