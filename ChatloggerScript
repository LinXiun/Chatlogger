--// Chat Logger with Dropdown Multi-Select Button
--// Put this LocalScript in StarterPlayerScripts

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer

-- ScreenGui
local gui = Instance.new("ScreenGui")
gui.Name = "ChatLoggerGui"
gui.ResetOnSpawn = false
gui.Parent = localPlayer:WaitForChild("PlayerGui")

-- Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 500, 0, 350)
frame.Position = UDim2.new(0.5, -250, 0.5, -175)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

-- Dropdown Button
local dropButton = Instance.new("TextButton")
dropButton.Size = UDim2.new(0, 160, 0, 32)
dropButton.Position = UDim2.new(0, 10, 0, 10)
dropButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
dropButton.TextColor3 = Color3.new(1, 1, 1)
dropButton.Font = Enum.Font.SourceSansBold
dropButton.TextSize = 16
dropButton.Text = "Select Player(s) ▼"
dropButton.Parent = frame
Instance.new("UICorner", dropButton).CornerRadius = UDim.new(0, 8)

-- Dropdown Frame (Hidden)
local dropFrame = Instance.new("Frame")
dropFrame.Size = UDim2.new(0, 160, 0, 0)
dropFrame.Position = UDim2.new(0, 10, 0, 42)
dropFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
dropFrame.BorderSizePixel = 0
dropFrame.ClipsDescendants = true
dropFrame.Visible = false
dropFrame.Parent = frame
Instance.new("UICorner", dropFrame).CornerRadius = UDim.new(0, 8)

local playerList = Instance.new("ScrollingFrame")
playerList.Size = UDim2.new(1, -4, 1, -4)
playerList.Position = UDim2.new(0, 2, 0, 2)
playerList.BackgroundTransparency = 1
playerList.ScrollBarThickness = 6
playerList.AutomaticCanvasSize = Enum.AutomaticSize.Y
playerList.CanvasSize = UDim2.new(0, 0, 0, 0)
playerList.Parent = dropFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 4)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = playerList

-- Chat Frame
local chatFrame = Instance.new("ScrollingFrame")
chatFrame.Size = UDim2.new(1, -20, 1, -60)
chatFrame.Position = UDim2.new(0, 10, 0, 50)
chatFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
chatFrame.BorderSizePixel = 0
chatFrame.ScrollBarThickness = 8
chatFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
chatFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
chatFrame.Parent = frame
local chatLayout = Instance.new("UIListLayout")
chatLayout.SortOrder = Enum.SortOrder.LayoutOrder
chatLayout.Padding = UDim.new(0, 4)
chatLayout.Parent = chatFrame

-- Scroll-to-bottom button
local scrollBtn = Instance.new("TextButton")
scrollBtn.Size = UDim2.new(0, 140, 0, 32)
scrollBtn.Position = UDim2.new(1, -150, 1, -40)
scrollBtn.AnchorPoint = Vector2.new(0, 0)
scrollBtn.Text = "Scroll to Bottom ↓"
scrollBtn.TextSize = 16
scrollBtn.Font = Enum.Font.SourceSansBold
scrollBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
scrollBtn.TextColor3 = Color3.new(1, 1, 1)
scrollBtn.Visible = false
scrollBtn.Parent = frame
scrollBtn.BackgroundTransparency = 1
scrollBtn.TextTransparency = 1
Instance.new("UICorner", scrollBtn).CornerRadius = UDim.new(0, 8)

-- Fade helper
local function fadeButton(button, visible)
	local goal = {}
	if visible then
		goal.BackgroundTransparency = 0
		goal.TextTransparency = 0
	else
		goal.BackgroundTransparency = 1
		goal.TextTransparency = 1
	end
	local tween = TweenService:Create(button, TweenInfo.new(0.25), goal)
	tween:Play()
	if visible then
		button.Visible = true
	else
		task.delay(0.25, function()
			if not visible then button.Visible = false end
		end)
	end
end

-- Selected players
local selectedPlayers = {}

-- Populate dropdown list
local function updatePlayerList()
	playerList:ClearAllChildren()
	for _, plr in ipairs(Players:GetPlayers()) do
		local b = Instance.new("TextButton")
		b.Size = UDim2.new(1, -10, 0, 25)
		b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
		b.TextColor3 = Color3.new(1, 1, 1)
		b.Text = plr.DisplayName
		b.Font = Enum.Font.SourceSans
		b.TextSize = 16
		b.Parent = playerList
		Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)

		b.MouseButton1Click:Connect(function()
			if selectedPlayers[plr.UserId] then
				selectedPlayers[plr.UserId] = nil
				b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
			else
				selectedPlayers[plr.UserId] = plr
				b.BackgroundColor3 = Color3.fromRGB(100, 180, 100)
			end
		end)
	end
end

updatePlayerList()
Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(updatePlayerList)

-- Toggle dropdown animation
local dropOpen = false
local function toggleDropdown()
	if dropOpen then
		dropOpen = false
		TweenService:Create(dropFrame, TweenInfo.new(0.25), {Size = UDim2.new(0, 160, 0, 0)}):Play()
		task.delay(0.25, function() dropFrame.Visible = false end)
	else
		dropFrame.Visible = true
		dropOpen = true
		TweenService:Create(dropFrame, TweenInfo.new(0.25), {Size = UDim2.new(0, 160, 0, 150)}):Play()
	end
end

dropButton.MouseButton1Click:Connect(toggleDropdown)

-- Click outside to close dropdown
UserInputService.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 and dropOpen then
		local m = UserInputService:GetMouseLocation()
		local abs = dropFrame.AbsolutePosition
		local sz = dropFrame.AbsoluteSize
		local absBtn = dropButton.AbsolutePosition
		local szBtn = dropButton.AbsoluteSize
		if not (
			(m.X > abs.X and m.X < abs.X + sz.X and m.Y > abs.Y and m.Y < abs.Y + sz.Y) or
			(m.X > absBtn.X and m.X < absBtn.X + szBtn.X and m.Y > absBtn.Y and m.Y < absBtn.Y + szBtn.Y)
		) then
			toggleDropdown()
		end
	end
end)

-- Player color function
local playerColors = {}
local function getColor(plr)
	if not playerColors[plr.UserId] then
		playerColors[plr.UserId] = Color3.fromHSV(math.random(), 0.6, 1)
	end
	return playerColors[plr.UserId]
end

-- Add chat message
local function addChat(player, message)
	message = message:gsub("#", "")
	local lbl = Instance.new("TextLabel")
	lbl.BackgroundTransparency = 1
	lbl.Size = UDim2.new(1, -10, 0, 20)
	lbl.Font = Enum.Font.SourceSans
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextSize = 16
	lbl.TextWrapped = true
	lbl.RichText = true
	local color = getColor(player)
	local prefix = string.format('<font color="rgb(%d,%d,%d)">%s</font>', color.R*255, color.G*255, color.B*255, player.DisplayName)
	lbl.Text = string.format("[%s] %s: %s", os.date("%H:%M:%S"), prefix, message)
	lbl.TextColor3 = Color3.new(1, 1, 1)
	lbl.Parent = chatFrame

	local atBottom = chatFrame.CanvasPosition.Y + chatFrame.AbsoluteWindowSize.Y >= chatFrame.AbsoluteCanvasSize.Y - 5
	task.defer(function()
		if atBottom then
			chatFrame.CanvasPosition = Vector2.new(0, chatFrame.AbsoluteCanvasSize.Y)
		end
	end)
end

-- Scroll button visibility
local visible = false
local function updateScroll()
	local gap = chatFrame.AbsoluteCanvasSize.Y - (chatFrame.CanvasPosition.Y + chatFrame.AbsoluteWindowSize.Y)
	local show = gap > 20
	if show ~= visible then
		visible = show
		fadeButton(scrollBtn, show)
	end
end

chatFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(updateScroll)
chatFrame:GetPropertyChangedSignal("AbsoluteCanvasSize"):Connect(updateScroll)

scrollBtn.MouseButton1Click:Connect(function()
	TweenService:Create(chatFrame, TweenInfo.new(0.3), {CanvasPosition = Vector2.new(0, chatFrame.AbsoluteCanvasSize.Y)}):Play()
end)

-- Hook chat system
local ChatEvent = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
if ChatEvent and ChatEvent:FindFirstChild("OnMessageDoneFiltering") then
	ChatEvent.OnMessageDoneFiltering.OnClientEvent:Connect(function(data)
		local sender = Players:FindFirstChild(data.FromSpeaker)
		if sender then
			if next(selectedPlayers) == nil or selectedPlayers[sender.UserId] then
				addChat(sender, data.Message)
				updateScroll()
			end
		end
	end)
end

print("[ChatLogger] Dropdown multi-select chat logger loaded.")