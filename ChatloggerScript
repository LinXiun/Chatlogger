-- Chat Logger GUI (DisplayName, 12hr format, Spectate safe, Dropdown filter, Transparent, Rounded)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.65
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
header.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -160, 1, 0)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger"
title.TextColor3 = Color3.fromRGB(220, 220, 220)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Return button
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 24, 0, 24)
returnBtn.Position = UDim2.new(1, -84, 0, 2)
returnBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
returnBtn.BorderSizePixel = 0
returnBtn.Text = "âŸ³"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 18
returnBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
returnBtn.Parent = header
Instance.new("UICorner", returnBtn).CornerRadius = UDim.new(0, 6)

-- Dropdown toggle button (%)
local dropdownBtn = Instance.new("TextButton")
dropdownBtn.Size = UDim2.new(0, 24, 0, 24)
dropdownBtn.Position = UDim2.new(1, -56, 0, 2)
dropdownBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
dropdownBtn.BorderSizePixel = 0
dropdownBtn.Text = "%"
dropdownBtn.Font = Enum.Font.SourceSansBold
dropdownBtn.TextSize = 18
dropdownBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
dropdownBtn.Parent = header
Instance.new("UICorner", dropdownBtn).CornerRadius = UDim.new(0, 6)

-- Hide button
local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 24, 0, 24)
hideBtn.Position = UDim2.new(1, -28, 0, 2)
hideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
hideBtn.BorderSizePixel = 0
hideBtn.Text = "v"
hideBtn.Font = Enum.Font.SourceSansBold
hideBtn.TextSize = 14
hideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
hideBtn.Parent = header
Instance.new("UICorner", hideBtn).CornerRadius = UDim.new(0, 6)

-- Unhide button
local unhideBtn = Instance.new("TextButton")
unhideBtn.Size = UDim2.new(0, 30, 0, 30)
unhideBtn.Position = UDim2.new(0, 10, 0, 10)
unhideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
unhideBtn.BorderSizePixel = 0
unhideBtn.Text = "^"
unhideBtn.Font = Enum.Font.SourceSansBold
unhideBtn.TextSize = 18
unhideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
unhideBtn.Visible = false
unhideBtn.Active = true
unhideBtn.Draggable = true
unhideBtn.Parent = screenGui
Instance.new("UICorner", unhideBtn).CornerRadius = UDim.new(0, 6)

hideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
	unhideBtn.Visible = true
end)
unhideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = true
	unhideBtn.Visible = false
end)

-- Dropdown setup
local dropdownWidth = 140
local dropdownOpen = false
local showAll = true
local selectedPlayers = {}
local messages = {}

-- Dropdown Frame (hidden by default)
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(0, dropdownWidth, 1, -36)
dropdownFrame.Position = UDim2.new(0, 0, 0, 36)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
dropdownFrame.BackgroundTransparency = 0.65
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Visible = false
dropdownFrame.Parent = mainFrame
Instance.new("UICorner", dropdownFrame).CornerRadius = UDim.new(0, 8)

-- Scrollable area for player list
local dropdownScroll = Instance.new("ScrollingFrame")
dropdownScroll.Size = UDim2.new(1, 0, 1, -6)
dropdownScroll.Position = UDim2.new(0, 0, 0, 3)
dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdownScroll.ScrollBarThickness = 6
dropdownScroll.BackgroundTransparency = 1
dropdownScroll.BorderSizePixel = 0
dropdownScroll.Parent = dropdownFrame

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.Padding = UDim.new(0, 4)
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Parent = dropdownScroll

-- Chat scroll frame (right side)
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
scrollFrame.BackgroundTransparency = 0.65
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame
Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = scrollFrame

-- Rebuild messages based on filter
local function rebuildMessages()
	for _, child in ipairs(scrollFrame:GetChildren()) do
		if not child:IsA("UIListLayout") then child:Destroy() end
	end

	for _, msgData in ipairs(messages) do
		if showAll or selectedPlayers[msgData.username] then
			task.defer(function()
				msgData.render(msgData)
			end)
		end
	end
end

-- Refresh dropdown list
local function refreshDropdown()
	for _, child in ipairs(dropdownScroll:GetChildren()) do
		if not child:IsA("UIListLayout") then
			child:Destroy()
		end
	end

	-- All button (always on top)
	local allBtn = Instance.new("TextButton")
	allBtn.Size = UDim2.new(1, -8, 0, 26)
	allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
	allBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
	allBtn.Font = Enum.Font.SourceSansBold
	allBtn.TextSize = 16
	allBtn.Text = "All"
	allBtn.BorderSizePixel = 0
	allBtn.Parent = dropdownScroll
	Instance.new("UICorner", allBtn).CornerRadius = UDim.new(0, 6)

	allBtn.MouseButton1Click:Connect(function()
		showAll = true
		selectedPlayers = {}
		refreshDropdown()
		rebuildMessages()
	end)

	-- Individual player buttons
	for _, p in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 26)
		btn.BackgroundColor3 = selectedPlayers[p.Name] and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
		btn.TextColor3 = Color3.fromRGB(240, 240, 240)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 14
		btn.Text = p.DisplayName .. " (@" .. p.Name .. ")"
		btn.BorderSizePixel = 0
		btn.Parent = dropdownScroll
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

		btn.MouseButton1Click:Connect(function()
			showAll = false
			selectedPlayers[p.Name] = not selectedPlayers[p.Name]
			refreshDropdown()
			rebuildMessages()
		end)
	end

	task.defer(function()
		dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
	end)
end

-- Toggle dropdown open/close
dropdownBtn.MouseButton1Click:Connect(function()
	dropdownOpen = not dropdownOpen
	dropdownFrame.Visible = dropdownOpen
	if dropdownOpen then
		scrollFrame.Position = UDim2.new(0, dropdownWidth + 6, 0, 36)
		scrollFrame.Size = UDim2.new(1, -dropdownWidth - 6, 1, -36)
	else
		scrollFrame.Position = UDim2.new(0, 0, 0, 36)
		scrollFrame.Size = UDim2.new(1, 0, 1, -36)
	end
end)

Players.PlayerAdded:Connect(refreshDropdown)
Players.PlayerRemoving:Connect(refreshDropdown)

-- Function to get unique, consistent color per player
local function getColorFromName(name)
	local hash = 0
	for i = 1, #name do
		hash = (hash + string.byte(name, i) * i) % 255
	end
	return Color3.fromHSV((hash % 50) / 50, 0.8, 1)
end

-- Track click count for teleport
local clickTimes = {}

-- Function to spectate player
local function spectatePlayer(target)
	if target and target.Character and target.Character:FindFirstChild("Humanoid") then
		camera.CameraSubject = target.Character:FindFirstChild("Humanoid")
	end
end

-- Function to teleport player to target
local function teleportToPlayer(target)
	if target and target.Character and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = player.Character.HumanoidRootPart
		local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
		if targetHRP then
			hrp.CFrame = targetHRP.CFrame + Vector3.new(0, 3, 0)
		end
	end
end

-- Function to format time in 12hr format
local function formatTime()
	local t = os.date("*t")
	local hour = t.hour % 12
	if hour == 0 then hour = 12 end
	local min = string.format("%02d", t.min)
	local ampm = t.hour >= 12 and "PM" or "AM"
	return string.format("[%d:%s%s]", hour, min, ampm)
end

-- Function to copy message to clipboard
local function copyToClipboard(text)
	if setclipboard then
		setclipboard(text)
	elseif toclipboard then
		toclipboard(text)
	end
end

-- Function to create and render message
local function createMessage(p, text)
	local msgFrame = Instance.new("TextButton")
	msgFrame.AutoButtonColor = false
	msgFrame.BackgroundTransparency = 1
	msgFrame.Size = UDim2.new(1, -6, 0, 22)
	msgFrame.Text = ""
	msgFrame.Parent = scrollFrame

	local timestamp = Instance.new("TextLabel")
	timestamp.Size = UDim2.new(0, 70, 1, 0)
	timestamp.BackgroundTransparency = 1
	timestamp.Text = formatTime()
	timestamp.TextColor3 = Color3.fromRGB(180, 180, 180)
	timestamp.Font = Enum.Font.Code
	timestamp.TextSize = 14
	timestamp.TextXAlignment = Enum.TextXAlignment.Left
	timestamp.Parent = msgFrame

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(0, 120, 1, 0)
	nameLabel.Position = UDim2.new(0, 75, 0, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = p.DisplayName
	nameLabel.TextColor3 = getColorFromName(p.Name)
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 14
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.Parent = msgFrame

	local msgText = Instance.new("TextLabel")
	msgText.Size = UDim2.new(1, -200, 1, 0)
	msgText.Position = UDim2.new(0, 200, 0, 0)
	msgText.BackgroundTransparency = 1
	msgText.Text = text
	msgText.TextColor3 = Color3.fromRGB(230, 230, 230)
	msgText.Font = Enum.Font.SourceSans
	msgText.TextSize = 14
	msgText.TextXAlignment = Enum.TextXAlignment.Left
	msgText.Parent = msgFrame

	-- Click events
	nameLabel.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			local now = tick()
			clickTimes[p.Name] = clickTimes[p.Name] or {}
			table.insert(clickTimes[p.Name], now)

			-- keep last 1 sec window
			for i = #clickTimes[p.Name], 1, -1 do
				if now - clickTimes[p.Name][i] > 1 then
					table.remove(clickTimes[p.Name], i)
				end
			end

			if #clickTimes[p.Name] >= 3 then
				teleportToPlayer(p)
				clickTimes[p.Name] = {}
			else
				spectatePlayer(p)
			end
		end
	end)

	msgText.MouseButton1Click:Connect(function()
		copyToClipboard(text)
	end)

	table.insert(messages, {
		username = p.Name,
		displayname = p.DisplayName,
		text = text,
		render = function()
			local clone = msgFrame:Clone()
			clone.Parent = scrollFrame
			clone.Visible = true
		end
	})

	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
end

-- ðŸ§© PART 4 â€” Chat Connections & Final Setup

-- Capture chat messages (TextChatService preferred)
local function hookChat()
	if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
		-- Modern chat system
		TextChatService.MessageReceived:Connect(function(message)
			local sender = message.TextSource and Players:FindFirstChild(message.TextSource.Name)
			if sender then
				if showAll or selectedPlayers[sender.Name] then
					createMessage(sender, message.Text)
				else
					table.insert(messages, {
						username = sender.Name,
						displayname = sender.DisplayName,
						text = message.Text,
						render = function() createMessage(sender, message.Text) end
					})
				end
			end
		end)
	else
		-- Legacy chat system (fallback)
		for _, p in ipairs(Players:GetPlayers()) do
			p.Chatted:Connect(function(msg)
				if showAll or selectedPlayers[p.Name] then
					createMessage(p, msg)
				else
					table.insert(messages, {
						username = p.Name,
						displayname = p.DisplayName,
						text = msg,
						render = function() createMessage(p, msg) end
					})
				end
			end)
		end

		Players.PlayerAdded:Connect(function(p)
			p.Chatted:Connect(function(msg)
				if showAll or selectedPlayers[p.Name] then
					createMessage(p, msg)
				else
					table.insert(messages, {
						username = p.Name,
						displayname = p.DisplayName,
						text = msg,
						render = function() createMessage(p, msg) end
					})
				end
			end)
		end)
	end
end

-- Handle return button (reset camera)
returnBtn.MouseButton1Click:Connect(function()
	if player.Character and player.Character:FindFirstChild("Humanoid") then
		camera.CameraSubject = player.Character.Humanoid
	end
end)

-- Initialize dropdown and chat
refreshDropdown()
hookChat()

-- Auto adjust chat panel when dropdown toggles
dropdownLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
end)

-- Final cleanup
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
end)

print("[âœ… Chat Logger Loaded Successfully]")