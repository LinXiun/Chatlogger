--// Chat Logger with Dropdown Player Filter
--// Full Script – Paste into StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 400)
mainFrame.Position = UDim2.new(0, 20, 0, 100)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 10)

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 30)
header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
header.BorderSizePixel = 0
header.Parent = mainFrame
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -40, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger ▼"
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Filter Button (Dropdown toggle)
local filterBtn = Instance.new("TextButton")
filterBtn.Size = UDim2.new(0, 30, 1, 0)
filterBtn.Position = UDim2.new(1, -35, 0, 0)
filterBtn.BackgroundTransparency = 1
filterBtn.Text = "▼"
filterBtn.Font = Enum.Font.GothamBold
filterBtn.TextSize = 14
filterBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
filterBtn.Parent = header

-- Message log container
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -10, 1, -40)
scrollFrame.Position = UDim2.new(0, 5, 0, 35)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 2)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = scrollFrame

-- Function to format time
local function getTime()
	local time = os.date("*t")
	local hour = ((time.hour - 1) % 12) + 1
	local ampm = (time.hour < 12) and "AM" or "PM"
	return string.format("[%02d:%02d%s]", hour, time.min, ampm)
end

-- Filter system
local selectedPlayers = {}

-- Dropdown container (scrollable + outside-click close)
local dropdownContainer = Instance.new("Frame")
dropdownContainer.Size = UDim2.new(0, 240, 0, 0)
dropdownContainer.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
dropdownContainer.BorderSizePixel = 0
dropdownContainer.ClipsDescendants = true
dropdownContainer.Visible = false
dropdownContainer.ZIndex = 5
dropdownContainer.Parent = screenGui
Instance.new("UICorner", dropdownContainer).CornerRadius = UDim.new(0, 6)

local dropdownCanvas = Instance.new("ScrollingFrame")
dropdownCanvas.Size = UDim2.new(1, 0, 1, 0)
dropdownCanvas.BackgroundTransparency = 1
dropdownCanvas.BorderSizePixel = 0
dropdownCanvas.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownCanvas.ScrollBarThickness = 6
dropdownCanvas.ZIndex = 6
dropdownCanvas.Parent = dropdownContainer

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Padding = UDim.new(0, 2)
dropdownLayout.Parent = dropdownCanvas

-- Function to update dropdown position to follow mainFrame
local function updateDropdownPosition()
	local absPos = header.AbsolutePosition
	dropdownContainer.Position = UDim2.fromOffset(absPos.X + 8, absPos.Y + header.AbsoluteSize.Y)
end

mainFrame:GetPropertyChangedSignal("Position"):Connect(updateDropdownPosition)
mainFrame:GetPropertyChangedSignal("Size"):Connect(updateDropdownPosition)

-- Dropdown open/close animation
local dropdownTween
local function setDropdownHeight(px)
	if dropdownTween then dropdownTween:Cancel() end
	dropdownTween = TweenService:Create(dropdownContainer, TweenInfo.new(0.18), {Size = UDim2.new(0, 240, 0, px)})
	dropdownTween:Play()
end

filterBtn.MouseButton1Click:Connect(function()
	if dropdownContainer.Visible then
		setDropdownHeight(0)
		task.delay(0.18, function() dropdownContainer.Visible = false end)
	else
		updateDropdownPosition()
		dropdownContainer.Visible = true
		local desired = math.clamp(dropdownLayout.AbsoluteContentSize.Y + 6, 40, 180)
		setDropdownHeight(desired)
	end
end)

-- Close dropdown when clicking outside
screenGui.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		if dropdownContainer.Visible then
			local mousePos = input.Position
			local absPos = dropdownContainer.AbsolutePosition
			local absSize = dropdownContainer.AbsoluteSize
			local inside = mousePos.X > absPos.X and mousePos.X < absPos.X + absSize.X and mousePos.Y > absPos.Y and mousePos.Y < absPos.Y + absSize.Y
			local insideHeader = mousePos.X > header.AbsolutePosition.X and mousePos.X < header.AbsolutePosition.X + header.AbsoluteSize.X and mousePos.Y > header.AbsolutePosition.Y and mousePos.Y < header.AbsolutePosition.Y + header.AbsoluteSize.Y
			if not inside and not insideHeader then
				setDropdownHeight(0)
				task.delay(0.18, function() dropdownContainer.Visible = false end)
			end
		end
	end
end)

-- Function to rebuild dropdown list
local function rebuildDropdown()
	for _, child in ipairs(dropdownCanvas:GetChildren()) do
		if child:IsA("Frame") then child:Destroy() end
	end

	for _, plr in ipairs(Players:GetPlayers()) do
		local item = Instance.new("Frame")
		item.Size = UDim2.new(1, -6, 0, 22)
		item.BackgroundTransparency = 1
		item.ZIndex = 7
		item.Parent = dropdownCanvas

		local checkbox = Instance.new("TextButton")
		checkbox.Size = UDim2.new(0, 20, 0, 20)
		checkbox.BackgroundColor3 = selectedPlayers[plr.UserId] and Color3.fromRGB(70, 130, 255) or Color3.fromRGB(60, 60, 60)
		checkbox.Text = ""
		checkbox.ZIndex = 8
		checkbox.Parent = item
		Instance.new("UICorner", checkbox).CornerRadius = UDim.new(0, 4)

		local nameLbl = Instance.new("TextLabel")
		nameLbl.Size = UDim2.new(1, -26, 1, 0)
		nameLbl.Position = UDim2.new(0, 26, 0, 0)
		nameLbl.BackgroundTransparency = 1
		nameLbl.Text = plr.DisplayName
		nameLbl.Font = Enum.Font.Gotham
		nameLbl.TextSize = 13
		nameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
		nameLbl.TextXAlignment = Enum.TextXAlignment.Left
		nameLbl.ZIndex = 8
		nameLbl.Parent = item

		checkbox.MouseButton1Click:Connect(function()
			selectedPlayers[plr.UserId] = not selectedPlayers[plr.UserId]
			checkbox.BackgroundColor3 = selectedPlayers[plr.UserId] and Color3.fromRGB(70, 130, 255) or Color3.fromRGB(60, 60, 60)
		end)
	end
end

Players.PlayerAdded:Connect(rebuildDropdown)
Players.PlayerRemoving:Connect(rebuildDropdown)
rebuildDropdown()

-- Function to add message
local function addMessage(speaker, message)
	if next(selectedPlayers) then
		if not selectedPlayers[speaker.UserId] then return end
	end

	local msg = Instance.new("TextLabel")
	msg.Size = UDim2.new(1, -6, 0, 18)
	msg.BackgroundTransparency = 1
	msg.TextXAlignment = Enum.TextXAlignment.Left
	msg.Font = Enum.Font.Gotham
	msg.TextSize = 13
	msg.TextColor3 = Color3.fromRGB(255, 255, 255)
	msg.Text = string.format("%s %s: %s", getTime(), speaker.DisplayName, message)
	msg.Parent = scrollFrame
end

-- Connect chat listener
TextChatService.OnIncomingMessage = function(msg)
	local props = msg.TextSource
	if props then
		local speaker = Players:GetPlayerByUserId(props.UserId)
		if speaker then
			addMessage(speaker, msg.Text)
		end
	end
end