-- Chat Logger — Final Stable Version (split parts)
-- Part 1/5: Setup & Header

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Utility: safe clipboard calls
local function safeSetClipboard(text)
    if setclipboard then
        pcall(setclipboard, text)
    elseif toclipboard then
        pcall(toclipboard, text)
    end
end

-- UI root
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
mainFrame.BackgroundTransparency = 0.65
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
local mainCorner = Instance.new("UICorner", mainFrame)
mainCorner.CornerRadius = UDim.new(0, 8)

-- Header
local header = Instance.new("Frame")
header.Name = "Header"
header.Size = UDim2.new(1, 0, 0, 28)
header.Position = UDim2.new(0, 0, 0, 0)
header.BackgroundTransparency = 1
header.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -160, 1, 0)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger"
title.TextColor3 = Color3.fromRGB(220,220,220)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Return button
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 24, 0, 24)
returnBtn.Position = UDim2.new(1, -84, 0, 2)
returnBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
returnBtn.BorderSizePixel = 0
returnBtn.Text = "⟳"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 16
returnBtn.TextColor3 = Color3.fromRGB(240,240,240)
returnBtn.Parent = header
Instance.new("UICorner", returnBtn).CornerRadius = UDim.new(0,6)

-- Dropdown toggle (%) on right
local dropdownBtn = Instance.new("TextButton")
dropdownBtn.Size = UDim2.new(0, 24, 0, 24)
dropdownBtn.Position = UDim2.new(1, -56, 0, 2)
dropdownBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
dropdownBtn.BorderSizePixel = 0
dropdownBtn.Text = "%"
dropdownBtn.Font = Enum.Font.SourceSansBold
dropdownBtn.TextSize = 18
dropdownBtn.TextColor3 = Color3.fromRGB(240,240,240)
dropdownBtn.Parent = header
Instance.new("UICorner", dropdownBtn).CornerRadius = UDim.new(0,6)

-- Hide button
local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 24, 0, 24)
hideBtn.Position = UDim2.new(1, -28, 0, 2)
hideBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
hideBtn.BorderSizePixel = 0
hideBtn.Text = "v"
hideBtn.Font = Enum.Font.SourceSansBold
hideBtn.TextSize = 14
hideBtn.TextColor3 = Color3.fromRGB(240,240,240)
hideBtn.Parent = header
Instance.new("UICorner", hideBtn).CornerRadius = UDim.new(0,6)

-- Unhide floating button (when main hidden)
local unhideBtn = Instance.new("TextButton")
unhideBtn.Size = UDim2.new(0, 30, 0, 30)
unhideBtn.Position = UDim2.new(0, 10, 0, 10)
unhideBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
unhideBtn.BorderSizePixel = 0
unhideBtn.Text = "^"
unhideBtn.Font = Enum.Font.SourceSansBold
unhideBtn.TextSize = 18
unhideBtn.TextColor3 = Color3.fromRGB(240,240,240)
unhideBtn.Visible = false
unhideBtn.Parent = screenGui
Instance.new("UICorner", unhideBtn).CornerRadius = UDim.new(0,6)

hideBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    unhideBtn.Visible = true
end)
unhideBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = true
    unhideBtn.Visible = false
end)

-- Part 2/5: Dropdown panel & main chat area (layout)

-- Dropdown variables
local dropdownWidth = 140
local dropdownOpen = false
local showAll = true
local selectedPlayers = {}
local messages = {} -- stores {username, displayName, text}

-- Dropdown frame (left) — start closed (visible = false)
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(0, dropdownWidth, 1, -36)
dropdownFrame.Position = UDim2.new(0, 0, 0, 36)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
dropdownFrame.BackgroundTransparency = 0.65
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Visible = false
dropdownFrame.Parent = mainFrame
Instance.new("UICorner", dropdownFrame).CornerRadius = UDim.new(0,8)

local dropdownScroll = Instance.new("ScrollingFrame")
dropdownScroll.Size = UDim2.new(1, 0, 1, -6)
dropdownScroll.Position = UDim2.new(0, 0, 0, 3)
dropdownScroll.CanvasSize = UDim2.new(0,0,0,0)
dropdownScroll.ScrollBarThickness = 6
dropdownScroll.BackgroundTransparency = 1
dropdownScroll.BorderSizePixel = 0
dropdownScroll.Parent = dropdownFrame

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.Padding = UDim.new(0,4)
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Parent = dropdownScroll

-- Chat scroll area (adjusts when dropdown toggled)
local chatScroll = Instance.new("ScrollingFrame")
chatScroll.Name = "ChatScroll"
chatScroll.Size = UDim2.new(1, 0, 1, -36)
chatScroll.Position = UDim2.new(0, 0, 0, 36)
chatScroll.BackgroundColor3 = Color3.fromRGB(30,30,30)
chatScroll.BackgroundTransparency = 0.65
chatScroll.BorderSizePixel = 0
chatScroll.CanvasSize = UDim2.new(0,0,0,0)
chatScroll.ScrollBarThickness = 6
chatScroll.Parent = mainFrame
Instance.new("UICorner", chatScroll).CornerRadius = UDim.new(0,8)

local chatLayout = Instance.new("UIListLayout")
chatLayout.SortOrder = Enum.SortOrder.LayoutOrder
chatLayout.Padding = UDim.new(0,4)
chatLayout.Parent = chatScroll

-- New messages indicator
local newMsgBtn = Instance.new("TextButton")
newMsgBtn.Size = UDim2.new(0, 160, 0, 26)
newMsgBtn.AnchorPoint = Vector2.new(0.5, 1)
newMsgBtn.Position = UDim2.new(0.5, 0, 1, -6)
newMsgBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
newMsgBtn.BackgroundTransparency = 0.4
newMsgBtn.Text = "New messages below ↓"
newMsgBtn.Font = Enum.Font.SourceSansBold
newMsgBtn.TextSize = 14
newMsgBtn.TextColor3 = Color3.fromRGB(255,255,255)
newMsgBtn.Visible = false
newMsgBtn.Parent = mainFrame
Instance.new("UICorner", newMsgBtn).CornerRadius = UDim.new(0,6)

newMsgBtn.MouseButton1Click:Connect(function()
    chatScroll.CanvasPosition = Vector2.new(0, math.max(0, chatLayout.AbsoluteContentSize.Y - chatScroll.AbsoluteSize.Y))
    newMsgBtn.Visible = false
end)

chatScroll:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
    local bottomThreshold = chatLayout.AbsoluteContentSize.Y - chatScroll.AbsoluteSize.Y - 20
    if chatScroll.CanvasPosition.Y >= bottomThreshold then
        newMsgBtn.Visible = false
    end
end)

-- Toggle dropdown behavior (dropdownBtn is on header right)
dropdownBtn.MouseButton1Click:Connect(function()
    dropdownOpen = not dropdownOpen
    dropdownFrame.Visible = dropdownOpen
    if dropdownOpen then
        chatScroll.Position = UDim2.new(0, dropdownWidth + 6, 0, 36)
        chatScroll.Size = UDim2.new(1, -dropdownWidth - 6, 1, -36)
    else
        chatScroll.Position = UDim2.new(0, 0, 0, 36)
        chatScroll.Size = UDim2.new(1, 0, 1, -36)
    end
    refreshDropdown() -- safe to call even if declared later
end)

-- Part 3/5: Message rendering, color, timestamp, spectate/teleport, copy

-- Unique color generator (consistent)
local function getColorForName(name)
    local h = 0
    for i = 1, #name do
        h = (h * 31 + string.byte(name, i)) % 360
    end
    return Color3.fromHSV(h/360, 0.55, 0.95)
end

-- 12-hour timestamp (UTC+8)
local function formatTimestampUTCplus8()
    local now = os.time()
    local t = os.date("!*t", now + 8*3600)
    local h, m = t.hour, t.min
    local ampm = (h >= 12) and "PM" or "AM"
    if h == 0 then h = 12 elseif h > 12 then h = h - 12 end
    return string.format("%d:%02d %s", h, m, ampm)
end

-- click tracking for triple-click teleport
local clickTracker = {}

-- Build and render a single message entry (no overlap, smaller text size)
local function buildMessageEntry(msgData)
    -- parent container frame to prevent text overlapping edges
    local entry = Instance.new("Frame")
    entry.Size = UDim2.new(1, -8, 0, 0)
    entry.BackgroundTransparency = 1
    entry.AutomaticSize = Enum.AutomaticSize.Y
    entry.Parent = chatScroll

    -- timestamp
    local ts = Instance.new("TextLabel")
    ts.Size = UDim2.new(0, 66, 0, 18)
    ts.Position = UDim2.new(0, 4, 0, 0)
    ts.BackgroundTransparency = 1
    ts.Font = Enum.Font.Code
    ts.TextSize = 12
    ts.TextColor3 = Color3.fromRGB(160,160,160)
    ts.Text = formatTimestampUTCplus8()
    ts.TextXAlignment = Enum.TextXAlignment.Left
    ts.Parent = entry

    -- name button (clickable area for spectate/teleport)
    local nameBtn = Instance.new("TextButton")
    nameBtn.Size = UDim2.new(0, 110, 0, 18)
    nameBtn.Position = UDim2.new(0, 76, 0, 0)
    nameBtn.BackgroundTransparency = 1
    nameBtn.AutoButtonColor = false
    nameBtn.Font = Enum.Font.SourceSansBold
    nameBtn.TextSize = 14
    nameBtn.TextXAlignment = Enum.TextXAlignment.Left
    nameBtn.Text = msgData.displayName
    nameBtn.TextColor3 = getColorForName(msgData.username)
    nameBtn.Parent = entry

    -- message text as a TextButton so it supports clicks reliably
    local msgBtn = Instance.new("TextButton")
    msgBtn.Size = UDim2.new(1, -200, 0, 18)
    msgBtn.Position = UDim2.new(0, 192, 0, 0)
    msgBtn.BackgroundTransparency = 1
    msgBtn.AutoButtonColor = false
    msgBtn.Font = Enum.Font.SourceSans
    msgBtn.TextSize = 16 -- smaller as requested
    msgBtn.TextXAlignment = Enum.TextXAlignment.Left
    msgBtn.TextWrapped = true
    msgBtn.Text = msgData.text
    msgBtn.TextColor3 = Color3.fromRGB(230,230,230)
    msgBtn.Parent = entry

    -- adjust automatic size after text wraps
    msgBtn:GetPropertyChangedSignal("TextBounds"):Connect(function()
        task.defer(function()
            chatScroll.CanvasSize = UDim2.new(0, 0, 0, chatLayout.AbsoluteContentSize.Y + 8)
        end)
    end)

    -- single/tap triple click logic for nameBtn
    nameBtn.MouseButton1Click:Connect(function()
        local now = tick()
        clickTracker[msgData.username] = clickTracker[msgData.username] or {}
        table.insert(clickTracker[msgData.username], now)
        -- clean older than 0.8s
        for i = #clickTracker[msgData.username], 1, -1 do
            if now - clickTracker[msgData.username][i] > 0.8 then
                table.remove(clickTracker[msgData.username], i)
            end
        end
        if #clickTracker[msgData.username] >= 3 then
            -- teleport
            clickTracker[msgData.username] = {}
            local target = Players:FindFirstChild(msgData.username)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0,4,0)
                end
            end
        else
            -- spectate (single)
            local target = Players:FindFirstChild(msgData.username)
            if target and target.Character and target.Character:FindFirstChildOfClass("Humanoid") then
                camera.CameraType = Enum.CameraType.Custom
                camera.CameraSubject = target.Character:FindFirstChildOfClass("Humanoid")
            end
        end
    end)

    -- copy on click
    msgBtn.MouseButton1Click:Connect(function()
        safeSetClipboard(msgData.text)
        -- visual feedback: flash the text color briefly
        local prev = msgBtn.TextColor3
        msgBtn.TextColor3 = Color3.fromRGB(0,200,0)
        task.delay(0.45, function()
            if msgBtn and msgBtn.Parent then
                msgBtn.TextColor3 = prev
            end
        end)
    end)

    -- update canvas size
    task.defer(function()
        chatScroll.CanvasSize = UDim2.new(0, 0, 0, chatLayout.AbsoluteContentSize.Y + 8)
        local nearBottom = chatScroll.CanvasPosition.Y >= chatLayout.AbsoluteContentSize.Y - chatScroll.AbsoluteSize.Y - 40
        if nearBottom then
            chatScroll.CanvasPosition = Vector2.new(0, math.max(0, chatLayout.AbsoluteContentSize.Y - chatScroll.AbsoluteSize.Y))
        else
            newMsgBtn.Visible = true
        end
    end)
end

-- Helper: add message to storage + render if visible
local function addNewMessage(msg)
    table.insert(messages, msg)
    if showAll or selectedPlayers[msg.username] then
        buildMessageEntry(msg)
    end
end

-- Part 4/5: Dropdown population, rebuildMessages, refreshDropdown helpers

-- Rebuild all messages according to current filter (clears UI and re-renders)
local function rebuildMessages()
    -- clear existing entries (keep UIListLayout)
    for _, child in ipairs(chatScroll:GetChildren()) do
        if not child:IsA("UIListLayout") then
            child:Destroy()
        end
    end
    -- re-render from messages
    for _, m in ipairs(messages) do
        if showAll or selectedPlayers[m.username] then
            buildMessageEntry(m)
        end
    end
    -- update canvas
    task.defer(function()
        chatScroll.CanvasSize = UDim2.new(0, 0, 0, chatLayout.AbsoluteContentSize.Y + 8)
    end)
end

-- Refresh dropdown UI (All at top)
function refreshDropdown()
    -- clear existing entries but keep layout object
    for _, child in ipairs(dropdownScroll:GetChildren()) do
        if not child:IsA("UIListLayout") then
            child:Destroy()
        end
    end

    -- All button (on top)
    local allBtn = Instance.new("TextButton")
    allBtn.Size = UDim2.new(1, -8, 0, 26)
    allBtn.Position = UDim2.new(0, 4, 0, 0)
    allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50,200,50) or Color3.fromRGB(60,60,60)
    allBtn.TextColor3 = Color3.fromRGB(240,240,240)
    allBtn.Font = Enum.Font.SourceSansBold
    allBtn.TextSize = 14
    allBtn.Text = "All"
    allBtn.BorderSizePixel = 0
    allBtn.Parent = dropdownScroll
    Instance.new("UICorner", allBtn).CornerRadius = UDim.new(0,6)

    allBtn.MouseButton1Click:Connect(function()
        showAll = true
        selectedPlayers = {}
        refreshDropdown()
        rebuildMessages()
    end)

    -- each player button
    for _, plr in ipairs(Players:GetPlayers()) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, -8, 0, 26)
        btn.BackgroundColor3 = selectedPlayers[plr.Name] and Color3.fromRGB(50,200,50) or Color3.fromRGB(60,60,60)
        btn.BackgroundTransparency = 0.2
        btn.TextColor3 = Color3.fromRGB(240,240,240)
        btn.Font = Enum.Font.SourceSans
        btn.TextSize = 14
        btn.Text = plr.DisplayName .. " (@" .. plr.Name .. ")"
        btn.BorderSizePixel = 0
        btn.Parent = dropdownScroll
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

        btn.MouseButton1Click:Connect(function()
            showAll = false
            selectedPlayers[plr.Name] = not selectedPlayers[plr.Name]
            refreshDropdown()
            rebuildMessages()
        end)
    end

    task.defer(function()
        dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
    end)
end

-- Update dropdown when players join/leave
Players.PlayerAdded:Connect(function()
    refreshDropdown()
end)
Players.PlayerRemoving:Connect(function()
    refreshDropdown()
    rebuildMessages()
end)

-- Part 5/5: Chat hooks, init, return/hide behavior

-- Return button resets camera to local player
returnBtn.MouseButton1Click:Connect(function()
    if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
        camera.CameraSubject = player.Character:FindFirstChildOfClass("Humanoid")
        camera.CameraType = Enum.CameraType.Custom
    end
end)

-- Hide behavior already connected earlier; ensure unhide button visibility not interfering
unhideBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = true
    unhideBtn.Visible = false
end)

-- Hook into chat: prefer TextChatService.MessageReceived if available
if TextChatService and TextChatService.MessageReceived then
    TextChatService.MessageReceived:Connect(function(message)
        -- message.TextSource might be a table with UserId or Name; try to resolve reliably
        local src = message.TextSource
        local plr = nil
        if src then
            if src.UserId then
                plr = Players:GetPlayerByUserId(src.UserId)
            elseif src.Name then
                plr = Players:FindFirstChild(src.Name)
            end
        end
        if not plr then return end

        local entry = { username = plr.Name, displayName = plr.DisplayName, text = message.Text }
        -- store
        table.insert(messages, entry)
        -- render if visible
        if showAll or selectedPlayers[entry.username] then
            buildMessageEntry(entry)
        end
        -- update canvas
        task.defer(function()
            chatScroll.CanvasSize = UDim2.new(0,0,0,chatLayout.AbsoluteContentSize.Y + 8)
        end)
    end)
else
    -- Legacy fallback using Player.Chatted
    for _, p in ipairs(Players:GetPlayers()) do
        p.Chatted:Connect(function(msg)
            local entry = { username = p.Name, displayName = p.DisplayName, text = msg }
            table.insert(messages, entry)
            if showAll or selectedPlayers[entry.username] then
                buildMessageEntry(entry)
            end
            task.defer(function()
                chatScroll.CanvasSize = UDim2.new(0,0,0,chatLayout.AbsoluteContentSize.Y + 8)
            end)
        end)
    end
    Players.PlayerAdded:Connect(function(newP)
        newP.Chatted:Connect(function(msg)
            local entry = { username = newP.Name, displayName = newP.DisplayName, text = msg }
            table.insert(messages, entry)
            if showAll or selectedPlayers[entry.username] then
                buildMessageEntry(entry)
            end
            task.defer(function()
                chatScroll.CanvasSize = UDim2.new(0,0,0,chatLayout.AbsoluteContentSize.Y + 8)
            end)
        end)
    end)
end

-- Ensure dropdown starts closed (per your request)
dropdownFrame.Visible = false
dropdownOpen = false
chatScroll.Position = UDim2.new(0, 0, 0, 36)
chatScroll.Size = UDim2.new(1, 0, 1, -36)

-- Final init
refreshDropdown()
rebuildMessages()

print("Chat Logger loaded — transparent mode, dropdown closed, text size 16.")

