newMsgBtn.MouseButton1Click:Connect(function()
	scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
	hideNewMsgButton()
end)

scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
	local bottomThreshold = layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 20
	if scrollFrame.CanvasPosition.Y >= bottomThreshold then hideNewMsgButton() end
end)

-- Time formatting (UTC+8, 12hr)
local function formatTimestamp()
	local now = os.time()
	local utc8 = os.date("!*t", now + 8 * 3600)
	local h, m = utc8.hour, utc8.min
	local ampm = (h >= 12) and "PM" or "AM"
	if h == 0 then h = 12 elseif h > 12 then h -= 12 end
	return string.format("%d:%02d%s", h, m, ampm)
end

-- Username color
local function hashString(s)
	local h = 0
	for i = 1, #s do h = (h * 31 + string.byte(s, i)) % 0xFFFFFFFF end
	return h
end
local function hslToRgb(h, s, l)
	local function hue2rgb(p, q, t)
		if t < 0 then t += 1 end
		if t > 1 then t -= 1 end
		if t < 1/6 then return p + (q - p) * 6 * t end
		if t < 1/2 then return q end
		if t < 2/3 then return p + (q - p) * (2/3 - t) * 6 end
		return p
	end
	local q = l < 0.5 and l * (1 + s) or l + s - l * s
	local p = 2 * l - q
	return Color3.new(hue2rgb(p, q, h + 1/3), hue2rgb(p, q, h), hue2rgb(p, q, h - 1/3))
end
local colorCache = {}
local function getColorForName(name)
	if colorCache[name] then return colorCache[name] end
	local hue = (hashString(name) % 360) / 360
	local color = hslToRgb(hue, 0.55, 0.55)
	colorCache[name] = color
	return color
end

-- Spectate / Return / Teleport
local function spectatePlayer(name)
	local target = Players:FindFirstChild(name)
	if not target or not target.Character then return end
	local hum = target.Character:FindFirstChildOfClass("Humanoid")
	if hum then
		camera.CameraType = Enum.CameraType.Custom
		camera.CameraSubject = hum
	end
end
local function returnToLocal()
	local char = player.Character
	if not char then return end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if hum then
		camera.CameraType = Enum.CameraType.Custom
		camera.CameraSubject = hum
	end
end
returnBtn.MouseButton1Click:Connect(returnToLocal)

local function teleportToPlayer(name)
	local target = Players:FindFirstChild(name)
	if not target or not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then return end
	local targetHRP = target.Character.HumanoidRootPart
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart", 2)
	if not hrp then return end
	hrp.CFrame = CFrame.new(targetHRP.Position + Vector3.new(0, 4, 0))

	local flash = Instance.new("Frame")
	flash.Size = UDim2.new(1, 0, 1, 0)
	flash.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	flash.BackgroundTransparency = 0.5
	flash.ZIndex = 999
	flash.Parent = screenGui
	TweenService:Create(flash, TweenInfo.new(0.4), {BackgroundTransparency = 1}):Play()
	task.delay(0.5, function() flash:Destroy() end)

	local sound = Instance.new("Sound")
	sound.SoundId = "rbxassetid://9118823101"
	sound.Volume = 1
	sound.Parent = hrp
	sound:Play()
	game.Debris:AddItem(sound, 2)
end

-- Log messages
local function logMessage(text, displayName, username)
	if next(selectedPlayers) ~= nil and not selectedPlayers[username] then return end

	local entry = Instance.new("Frame")
	entry.Size = UDim2.new(1, -10, 0, 0)
	entry.BackgroundTransparency = 1
	entry.AutomaticSize = Enum.AutomaticSize.Y
	entry.Parent = scrollFrame

	local ts = Instance.new("TextLabel")
	ts.Size = UDim2.new(0, 50, 0, 18)
	ts.BackgroundTransparency = 1
	ts.Font = Enum.Font.Code
	ts.TextSize = 14
	ts.Text = formatTimestamp()
	ts.TextColor3 = Color3.fromRGB(160, 160, 160)
	ts.TextXAlignment = Enum.TextXAlignment.Left
	ts.Parent = entry

	local nameBtn = Instance.new("TextButton")
	nameBtn.Size = UDim2.new(0, 120, 0, 0)
	nameBtn.Position = UDim2.new(0, 54, 0, 0)
	nameBtn.BackgroundTransparency = 1
	nameBtn.Font = Enum.Font.SourceSansBold
	nameBtn.TextSize = 18
	nameBtn.Text = displayName
	nameBtn.TextColor3 = getColorForName(username)
	nameBtn.TextXAlignment = Enum.TextXAlignment.Left
	nameBtn.AutomaticSize = Enum.AutomaticSize.Y
	nameBtn.Parent = entry

	local clicks, lastClick = 0, 0
	nameBtn.MouseButton1Click:Connect(function()
		local now = tick()
		if now - lastClick < 0.6 then
			clicks += 1
		else
			clicks = 1
		end
		lastClick = now

		if clicks == 1 then
			spectatePlayer(username)
		elseif clicks == 3 then
			clicks = 0
			teleportToPlayer(username)
		end
	end)

	local msgBtn = Instance.new("TextButton")
	msgBtn.Size = UDim2.new(1, -160, 0, 0)
	msgBtn.Position = UDim2.new(0, 174, 0, 0)
	msgBtn.BackgroundTransparency = 1
	msgBtn.Font = Enum.Font.SourceSans
	msgBtn.TextSize = 18
	msgBtn.TextWrapped = true
	msgBtn.TextXAlignment = Enum.TextXAlignment.Left
	msgBtn.AutomaticSize = Enum.AutomaticSize.Y
	msgBtn.Text = text
	msgBtn.TextColor3 = Color3.fromRGB(220, 220, 220)
	msgBtn.AutoButtonColor = true
	msgBtn.Parent = entry

	msgBtn.MouseButton1Click:Connect(function()
		if setclipboard then
			setclipboard(text)
			msgBtn.TextColor3 = Color3.fromRGB(0, 255, 0)
			task.delay(0.5, function() msgBtn.TextColor3 = Color3.fromRGB(220, 220, 220) end)
		end
	end)

	task.defer(function()
		scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
		local nearBottom = scrollFrame.CanvasPosition.Y >= layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 40
		if nearBottom then
			scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
		else
			showNewMsgButton()
		end
	end)
end

-- Chat hook
updateDropdown()
titleBtn.MouseButton1Click:Connect(function()
	dropdownFrame.Visible = not dropdownFrame.Visible
	titleBtn.Text = dropdownFrame.Visible and "Chat Logger ▲" or "Chat Logger ▼"
	if dropdownFrame.Visible then
		scrollFrame.Position = UDim2.new(0, dropdownWidth + 6, 0, 36)
		scrollFrame.Size = UDim2.new(1, -dropdownWidth - 6, 1, -36)
	else
		scrollFrame.Position = UDim2.new(0, 0, 0, 36)
		scrollFrame.Size = UDim2.new(1, 0, 1, -36)
	end
end)

if TextChatService.MessageReceived then
	TextChatService.MessageReceived:Connect(function(msg)
		if msg.Text and msg.TextSource then
			local uid = msg.TextSource.UserId
			local dn, un = "[Unknown]", "[Unknown]"
			local plr = uid and Players:GetPlayerByUserId(uid)
			if plr then dn, un = plr.DisplayName, plr.Name end
			logMessage(msg.Text, dn, un)
		end
	end)
else
	for _, p in ipairs(Players:GetPlayers()) do
		p.Chatted:Connect(function(m) logMessage(m, p.DisplayName, p.Name) end)
	end
	Players.PlayerAdded:Connect(function(p)
		p.Chatted:Connect(function(m) logMessage(m, p.DisplayName, p.Name) end)
	end)
end