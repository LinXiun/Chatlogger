--// Chat Logger GUI (Transparent, Rounded, Draggable, Fixed Dropdown)

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Screen GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 400, 0, 350)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -175)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.65
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 36)
header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
header.BackgroundTransparency = 0.4
header.BorderSizePixel = 0
header.Parent = mainFrame
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -90, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger"
title.Font = Enum.Font.SourceSansBold
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 20
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Dropdown Toggle Button (restored)
local dropdownToggle = Instance.new("TextButton")
dropdownToggle.Size = UDim2.new(0, 30, 0, 24)
dropdownToggle.Position = UDim2.new(0, 10, 0, 6)
dropdownToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
dropdownToggle.BackgroundTransparency = 0.3
dropdownToggle.Text = "▼"
dropdownToggle.Font = Enum.Font.SourceSansBold
dropdownToggle.TextSize = 20
dropdownToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
dropdownToggle.Parent = header
Instance.new("UICorner", dropdownToggle).CornerRadius = UDim.new(0, 6)

-- Hide Button
local hideButton = Instance.new("TextButton")
hideButton.Size = UDim2.new(0, 24, 0, 24)
hideButton.Position = UDim2.new(1, -34, 0, 6)
hideButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
hideButton.BackgroundTransparency = 0.3
hideButton.Text = "−"
hideButton.Font = Enum.Font.SourceSansBold
hideButton.TextSize = 20
hideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
hideButton.Parent = header
Instance.new("UICorner", hideButton).CornerRadius = UDim.new(0, 6)

-- Return Button
local returnButton = Instance.new("TextButton")
returnButton.Size = UDim2.new(0, 24, 0, 24)
returnButton.Position = UDim2.new(1, -64, 0, 6)
returnButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
returnButton.BackgroundTransparency = 0.3
returnButton.Text = "⟳"
returnButton.Font = Enum.Font.SourceSansBold
returnButton.TextSize = 18
returnButton.TextColor3 = Color3.fromRGB(255, 255, 255)
returnButton.Parent = header
Instance.new("UICorner", returnButton).CornerRadius = UDim.new(0, 6)

-- Dropdown Panel (left side)
local dropdownWidth = 120
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(0, dropdownWidth, 1, -36)
dropdownFrame.Position = UDim2.new(0, 0, 0, 36)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
dropdownFrame.BackgroundTransparency = 0.65
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Visible = false
dropdownFrame.Parent = mainFrame
Instance.new("UICorner", dropdownFrame).CornerRadius = UDim.new(0, 8)

local dropdownScroll = Instance.new("ScrollingFrame")
dropdownScroll.Size = UDim2.new(1, 0, 1, -6)
dropdownScroll.Position = UDim2.new(0, 0, 0, 3)
dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdownScroll.ScrollBarThickness = 6
dropdownScroll.BackgroundTransparency = 1
dropdownScroll.BorderSizePixel = 0
dropdownScroll.Parent = dropdownFrame

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.Padding = UDim.new(0, 4)
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Parent = dropdownScroll

-- Chat panel
local chatFrame = Instance.new("Frame")
chatFrame.Position = UDim2.new(0, 0, 0, 36)
chatFrame.Size = UDim2.new(1, 0, 1, -36)
chatFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
chatFrame.BackgroundTransparency = 0.65
chatFrame.BorderSizePixel = 0
chatFrame.Parent = mainFrame
Instance.new("UICorner", chatFrame).CornerRadius = UDim.new(0, 8)

-- ScrollFrame for chat logs
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -30)
scrollFrame.Position = UDim2.new(0, 0, 0, 0)
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = chatFrame

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 2)
layout.Parent = scrollFrame

-- Data
local messages = {}
local selectedPlayers = {}
local showAll = true
local dropdownOpen = false

-- Functions
local function rebuildMessages()
	for _, child in ipairs(scrollFrame:GetChildren()) do
		if child:IsA("TextLabel") then child:Destroy() end
	end
	for _, data in ipairs(messages) do
		if showAll or selectedPlayers[data.username] then
			local label = Instance.new("TextLabel")
			label.Size = UDim2.new(1, -10, 0, 20)
			label.BackgroundTransparency = 1
			label.TextXAlignment = Enum.TextXAlignment.Left
			label.Font = Enum.Font.SourceSans
			label.TextSize = 16
			label.TextColor3 = Color3.fromRGB(255, 255, 255)
			label.Text = "[" .. data.displayName .. "]: " .. data.text
			label.Parent = scrollFrame

			local clickCount = 0
			label.MouseButton1Click:Connect(function()
				clickCount += 1
				task.delay(0.5, function() clickCount = 0 end)
				local target = Players:FindFirstChild(data.username)
				if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
					if clickCount == 1 then
						camera.CameraSubject = target.Character:FindFirstChild("Humanoid")
					elseif clickCount == 3 then
						player.Character:MoveTo(target.Character.HumanoidRootPart.Position + Vector3.new(0, 3, 0))
					end
				end
			end)
		end
	end
	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
end

-- Dropdown Refresh
local function refreshDropdown()
	for _, child in ipairs(dropdownScroll:GetChildren()) do
		if not child:IsA("UIListLayout") then child:Destroy() end
	end

	-- "All" Button
	local allBtn = Instance.new("TextButton")
	allBtn.Size = UDim2.new(1, -8, 0, 26)
	allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
	allBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
	allBtn.Font = Enum.Font.SourceSansBold
	allBtn.TextSize = 16
	allBtn.Text = "All"
	allBtn.BorderSizePixel = 0
	allBtn.Parent = dropdownScroll
	Instance.new("UICorner", allBtn).CornerRadius = UDim.new(0, 6)

	allBtn.MouseButton1Click:Connect(function()
		showAll = not showAll
		if showAll then for k in pairs(selectedPlayers) do selectedPlayers[k] = nil end end
		refreshDropdown()
		rebuildMessages()
	end)

	for _, p in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 26)
		btn.BackgroundColor3 = selectedPlayers[p.Name] and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
		btn.TextColor3 = Color3.fromRGB(240, 240, 240)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 14
		btn.Text = p.DisplayName .. " (@" .. p.Name .. ")"
		btn.BorderSizePixel = 0
		btn.Parent = dropdownScroll
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

		btn.MouseButton1Click:Connect(function()
			selectedPlayers[p.Name] = not selectedPlayers[p.Name]
			showAll = false
			refreshDropdown()
			rebuildMessages()
		end)
	end

	task.defer(function()
		dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
	end)
end

-- Toggle Dropdown
dropdownToggle.MouseButton1Click:Connect(function()
	dropdownOpen = not dropdownOpen
	dropdownFrame.Visible = dropdownOpen
	if dropdownOpen then
		chatFrame.Position = UDim2.new(0, dropdownWidth, 0, 36)
		chatFrame.Size = UDim2.new(1, -dropdownWidth, 1, -36)
	else
		chatFrame.Position = UDim2.new(0, 0, 0, 36)
		chatFrame.Size = UDim2.new(1, 0, 1, -36)
	end
end)

-- Hide/Return
hideButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
	wait(0.5)
	returnButton.Visible = true
end)

returnButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = true
end)

Players.PlayerAdded:Connect(refreshDropdown)
Players.PlayerRemoving:Connect(refreshDropdown)

-- New message indicator
local newMsgBtn = Instance.new("TextButton")
newMsgBtn.Size = UDim2.new(1, 0, 0, 24)
newMsgBtn.Position = UDim2.new(0, 0, 1, -24)
newMsgBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
newMsgBtn.BackgroundTransparency = 0.5
newMsgBtn.Text = "New messages below ↓"
newMsgBtn.Font = Enum.Font.SourceSansBold
newMsgBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
newMsgBtn.TextSize = 16
newMsgBtn.Visible = false
newMsgBtn.Parent = mainFrame
Instance.new("UICorner", newMsgBtn).CornerRadius = UDim.new(0, 6)

newMsgBtn.MouseButton1Click:Connect(function()
	scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasSize.Y.Offset)
	newMsgBtn.Visible = false
end)

scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
	local maxScroll = scrollFrame.CanvasSize.Y.Offset - scrollFrame.AbsoluteWindowSize.Y
	if scrollFrame.CanvasPosition.Y < maxScroll - 40 then
		newMsgBtn.Visible = true
	else
		newMsgBtn.Visible = false
	end
end)

-- Listen for messages
TextChatService.MessageReceived:Connect(function(msg)
	local props = msg.TextSource
	if not props then return end
	local sender = Players:GetPlayerByUserId(props.UserId)
	if not sender then return end

	local messageData = {
		text = msg.Text,
		displayName = sender.DisplayName,
		username = sender.Name
	}

	table.insert(messages, messageData)
	rebuildMessages()
end)

-- Initialize
refreshDropdown()
rebuildMessages()