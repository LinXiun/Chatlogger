-- âœ… Chat Logger GUI (DisplayName, Multi-select Filter Dropdown, Fully Working)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

-- HEADER
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
header.Parent = mainFrame

-- ðŸ”½ FILTER BUTTON
local filterBtn = Instance.new("TextButton")
filterBtn.Size = UDim2.new(0, 140, 1, 0)
filterBtn.Position = UDim2.new(0, 8, 0, 0)
filterBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
filterBtn.BorderSizePixel = 0
filterBtn.Text = "Filter Players â–¼"
filterBtn.Font = Enum.Font.SourceSansBold
filterBtn.TextSize = 14
filterBtn.TextColor3 = Color3.fromRGB(240,240,240)
filterBtn.ZIndex = 10
filterBtn.Parent = header
Instance.new("UICorner", filterBtn).CornerRadius = UDim.new(0, 6)

-- ðŸ”½ DROPDOWN PANEL (fixed position, separate layer)
local dropdownContainer = Instance.new("Frame")
dropdownContainer.Size = UDim2.new(0, 240, 0, 0)
dropdownContainer.Position = UDim2.new(0, 10, 0, 38)
dropdownContainer.BackgroundColor3 = Color3.fromRGB(45,45,45)
dropdownContainer.BorderSizePixel = 0
dropdownContainer.ClipsDescendants = true
dropdownContainer.Visible = false
dropdownContainer.ZIndex = 15
dropdownContainer.Parent = screenGui
Instance.new("UICorner", dropdownContainer).CornerRadius = UDim.new(0, 6)

local dropdownCanvas = Instance.new("ScrollingFrame")
dropdownCanvas.Size = UDim2.new(1, 0, 1, 0)
dropdownCanvas.BackgroundTransparency = 1
dropdownCanvas.BorderSizePixel = 0
dropdownCanvas.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownCanvas.ScrollBarThickness = 6
dropdownCanvas.ZIndex = 16
dropdownCanvas.Parent = dropdownContainer

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Padding = UDim.new(0, 2)
dropdownLayout.Parent = dropdownCanvas

local dropdownTweenIn = TweenService:Create(dropdownContainer, TweenInfo.new(0.25), {Size = UDim2.new(0, 240, 0, 160)})
local dropdownTweenOut = TweenService:Create(dropdownContainer, TweenInfo.new(0.25), {Size = UDim2.new(0, 240, 0, 0)})

-- FILTER DATA
local selectedPlayers = {}

local function togglePlayerSelection(name)
	selectedPlayers[name] = not selectedPlayers[name]
end

local function createDropdownItem(plr)
	local item = Instance.new("TextButton")
	item.Size = UDim2.new(1, -8, 0, 24)
	item.BackgroundColor3 = Color3.fromRGB(60,60,60)
	item.BorderSizePixel = 0
	item.Text = "â˜  " .. plr.DisplayName
	item.TextColor3 = Color3.fromRGB(240,240,240)
	item.Font = Enum.Font.SourceSans
	item.TextSize = 14
	item.ZIndex = 16
	item.Parent = dropdownCanvas
	Instance.new("UICorner", item).CornerRadius = UDim.new(0, 4)

	item.MouseButton1Click:Connect(function()
		togglePlayerSelection(plr.Name)
		item.Text = (selectedPlayers[plr.Name] and "â˜‘  " or "â˜  ") .. plr.DisplayName
	end)
end

local function refreshDropdown()
	for _, child in ipairs(dropdownCanvas:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end
	for _, p in ipairs(Players:GetPlayers()) do
		createDropdownItem(p)
	end
end

Players.PlayerAdded:Connect(refreshDropdown)
Players.PlayerRemoving:Connect(refreshDropdown)
refreshDropdown()

filterBtn.MouseButton1Click:Connect(function()
	if dropdownContainer.Visible then
		dropdownTweenOut:Play()
		task.delay(0.25, function() dropdownContainer.Visible = false end)
	else
		refreshDropdown()
		dropdownContainer.Visible = true
		dropdownTweenIn:Play()
	end
end)

-- ðŸ—¨ï¸ CHAT PANEL
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = scrollFrame

-- UTILITIES
local function formatTimestamp()
	local now = os.date("!*t", os.time() + 8*3600)
	local hour, min = now.hour, now.min
	local ampm = (hour >= 12) and "PM" or "AM"
	if hour == 0 then hour = 12 elseif hour > 12 then hour -= 12 end
	return string.format("%d:%02d%s", hour, min, ampm)
end

-- CHAT LOGGING
local function logMessage(msg, displayName, username)
	if next(selectedPlayers) and not selectedPlayers[username] then return end

	local line = Instance.new("TextLabel")
	line.BackgroundTransparency = 1
	line.Size = UDim2.new(1, -8, 0, 0)
	line.AutomaticSize = Enum.AutomaticSize.Y
	line.Font = Enum.Font.Code
	line.TextSize = 16
	line.TextColor3 = Color3.fromRGB(240, 240, 240)
	line.TextXAlignment = Enum.TextXAlignment.Left
	line.TextWrapped = true
	line.Text = string.format("[%s] %s: %s", formatTimestamp(), displayName, msg)
	line.Parent = scrollFrame

	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
	scrollFrame.CanvasPosition = Vector2.new(0, layout.AbsoluteContentSize.Y)
end

-- CHAT CONNECTION
if TextChatService.MessageReceived then
	TextChatService.MessageReceived:Connect(function(message)
		if message.Text and message.TextSource then
			local uid = message.TextSource.UserId
			local plr = uid and Players:GetPlayerByUserId(uid)
			if plr then
				logMessage(message.Text, plr.DisplayName, plr.Name)
			end
		end
	end)
else
	for _, p in ipairs(Players:GetPlayers()) do
		p.Chatted:Connect(function(m) logMessage(m, p.DisplayName, p.Name) end)
	end
	Players.PlayerAdded:Connect(function(p)
		p.Chatted:Connect(function(m) logMessage(m, p.DisplayName, p.Name) end)
	end)
end