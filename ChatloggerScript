--// Chat Logger GUI (LocalScript)
--// Place this in StarterPlayerScripts

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local localPlayer = Players.LocalPlayer

--// Create GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChatLoggerGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = localPlayer:WaitForChild("PlayerGui")

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 500, 0, 350)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

-- Player list
local PlayerList = Instance.new("ScrollingFrame")
PlayerList.Size = UDim2.new(0, 150, 1, 0)
PlayerList.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
PlayerList.BorderSizePixel = 0
PlayerList.ScrollBarThickness = 6
PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerList.Parent = MainFrame

local PlayerListLayout = Instance.new("UIListLayout")
PlayerListLayout.Padding = UDim.new(0, 4)
PlayerListLayout.Parent = PlayerList

-- Chat frame
local ChatFrame = Instance.new("ScrollingFrame")
ChatFrame.Size = UDim2.new(1, -160, 1, -10)
ChatFrame.Position = UDim2.new(0, 155, 0, 5)
ChatFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ChatFrame.BorderSizePixel = 0
ChatFrame.ScrollBarThickness = 8
ChatFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatFrame.Parent = MainFrame

local ChatLayout = Instance.new("UIListLayout")
ChatLayout.SortOrder = Enum.SortOrder.LayoutOrder
ChatLayout.Padding = UDim.new(0, 4)
ChatLayout.Parent = ChatFrame

-- Scroll-to-bottom button
local ScrollDownButton = Instance.new("TextButton")
ScrollDownButton.Size = UDim2.new(0, 140, 0, 32)
ScrollDownButton.Position = UDim2.new(1, -160, 1, -45)
ScrollDownButton.AnchorPoint = Vector2.new(0, 0)
ScrollDownButton.Text = "Scroll to Bottom â†“"
ScrollDownButton.TextSize = 16
ScrollDownButton.Font = Enum.Font.SourceSansBold
ScrollDownButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
ScrollDownButton.TextColor3 = Color3.new(1, 1, 1)
ScrollDownButton.Visible = false
ScrollDownButton.Parent = MainFrame
ScrollDownButton.BackgroundTransparency = 1
ScrollDownButton.TextTransparency = 1

local ScrollCorner = Instance.new("UICorner")
ScrollCorner.CornerRadius = UDim.new(0, 8)
ScrollCorner.Parent = ScrollDownButton

-- Fade animation helper
local function fadeButton(visible)
	local goal = {}
	if visible then
		goal.BackgroundTransparency = 0
		goal.TextTransparency = 0
	else
		goal.BackgroundTransparency = 1
		goal.TextTransparency = 1
	end

	local tween = TweenService:Create(ScrollDownButton, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), goal)
	tween:Play()

	if visible then
		ScrollDownButton.Visible = true
		tween.Completed:Connect(function()
			ScrollDownButton.Active = true
		end)
	else
		ScrollDownButton.Active = false
		tween.Completed:Connect(function()
			if not visible then
				ScrollDownButton.Visible = false
			end
		end)
	end
end

-- Update player list
local function updatePlayerList()
	PlayerList:ClearAllChildren()
	for _, plr in ipairs(Players:GetPlayers()) do
		local button = Instance.new("TextButton")
		button.Size = UDim2.new(1, -10, 0, 25)
		button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
		button.TextColor3 = Color3.new(1, 1, 1)
		button.Text = plr.DisplayName
		button.Font = Enum.Font.SourceSansBold
		button.TextSize = 16
		button.Parent = PlayerList

		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 8)
		corner.Parent = button
	end
end

updatePlayerList()
Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(updatePlayerList)

-- Color memory per player
local playerColors = {}
local function getPlayerColor(plr)
	if not playerColors[plr.UserId] then
		playerColors[plr.UserId] = Color3.fromHSV(math.random(), 0.6, 1)
	end
	return playerColors[plr.UserId]
end

-- Add chat message
local function addChatMessage(player, message)
	message = message:gsub("#", "") -- remove hashtags

	local ChatLine = Instance.new("TextLabel")
	ChatLine.BackgroundTransparency = 1
	ChatLine.Size = UDim2.new(1, -10, 0, 20)
	ChatLine.Font = Enum.Font.SourceSans
	ChatLine.TextXAlignment = Enum.TextXAlignment.Left
	ChatLine.TextSize = 16
	ChatLine.TextWrapped = true
	ChatLine.RichText = true

	local color = getPlayerColor(player)
	local prefix = string.format('<font color="rgb(%d,%d,%d)">%s</font>',
		color.R * 255, color.G * 255, color.B * 255, player.DisplayName)
	local time = os.date("[%H:%M:%S]")
	ChatLine.Text = string.format("%s %s: %s", time, prefix, message)
	ChatLine.TextColor3 = Color3.new(1, 1, 1)

	local atBottom = false
	if ChatFrame.CanvasPosition.Y + ChatFrame.AbsoluteWindowSize.Y >= ChatFrame.AbsoluteCanvasSize.Y - 5 then
		atBottom = true
	end

	ChatLine.Parent = ChatFrame

	task.defer(function()
		if atBottom then
			ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.AbsoluteCanvasSize.Y)
		end
	end)
end

-- Detect scroll position and animate button
local buttonVisible = false
local function updateScrollButtonVisibility()
	local bottomGap = ChatFrame.AbsoluteCanvasSize.Y - (ChatFrame.CanvasPosition.Y + ChatFrame.AbsoluteWindowSize.Y)
	local shouldShow = bottomGap > 20
	if shouldShow ~= buttonVisible then
		buttonVisible = shouldShow
		fadeButton(shouldShow)
	end
end

ChatFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(updateScrollButtonVisibility)
ChatFrame:GetPropertyChangedSignal("AbsoluteCanvasSize"):Connect(updateScrollButtonVisibility)

-- Scroll button click
ScrollDownButton.MouseButton1Click:Connect(function()
	local tween = TweenService:Create(ChatFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
		{CanvasPosition = Vector2.new(0, ChatFrame.AbsoluteCanvasSize.Y)})
	tween:Play()
end)

-- Hook chat event
local ChatEvent = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
if ChatEvent and ChatEvent:FindFirstChild("OnMessageDoneFiltering") then
	ChatEvent.OnMessageDoneFiltering.OnClientEvent:Connect(function(data)
		local sender = Players:FindFirstChild(data.FromSpeaker)
		if sender then
			addChatMessage(sender, data.Message)
			updateScrollButtonVisibility()
		end
	end)
end

print("[ChatLogger] Loaded successfully (Animated scroll button).")