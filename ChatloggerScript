-- Chat Logger GUI (DisplayName, 12hr format, Spectate safe, Manual scroll, Bottom indicator, Compact, Click-to-copy)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.5
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
header.Parent = mainFrame

-- FILTER DROPDOWN (replaces title)
local filterBtn = Instance.new("TextButton")
filterBtn.Size = UDim2.new(0, 140, 1, 0)
filterBtn.Position = UDim2.new(0, 8, 0, 0)
filterBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
filterBtn.BorderSizePixel = 0
filterBtn.Text = "Filter Players ▼"
filterBtn.Font = Enum.Font.SourceSansBold
filterBtn.TextSize = 14
filterBtn.TextColor3 = Color3.fromRGB(240,240,240)
filterBtn.Parent = header
Instance.new("UICorner", filterBtn).CornerRadius = UDim.new(0, 6)

-- Dropdown container (hidden by default)
local dropdownContainer = Instance.new("Frame")
dropdownContainer.Size = UDim2.new(0, 240, 0, 0)
dropdownContainer.Position = UDim2.new(0, 8, 0, 28)
dropdownContainer.BackgroundColor3 = Color3.fromRGB(45,45,45)
dropdownContainer.BorderSizePixel = 0
dropdownContainer.ClipsDescendants = true
dropdownContainer.Visible = false
dropdownContainer.Parent = mainFrame
Instance.new("UICorner", dropdownContainer).CornerRadius = UDim.new(0, 6)

local dropdownCanvas = Instance.new("ScrollingFrame")
dropdownCanvas.Size = UDim2.new(1, 0, 1, 0)
dropdownCanvas.Position = UDim2.new(0, 0, 0, 0)
dropdownCanvas.BackgroundTransparency = 1
dropdownCanvas.BorderSizePixel = 0
dropdownCanvas.AutomaticCanvasSize = Enum.AutomaticSize.Y
dropdownCanvas.ScrollBarThickness = 6
dropdownCanvas.Parent = dropdownContainer

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Padding = UDim.new(0, 2)
dropdownLayout.Parent = dropdownCanvas

-- small helper to show number of selected players on the button
local selectedFilters = {} -- [username] = true
local function updateFilterButtonText()
    local count = 0
    for _, v in pairs(selectedFilters) do if v then count = count + 1 end end
    if count == 0 then
        filterBtn.Text = "Filter Players ▼"
    else
        filterBtn.Text = ("Filter Players (%d) ▼"):format(count)
    end
end

-- Tween open/close dropdown height
local dropdownOpenTween, dropdownCloseTween
local function setDropdownHeight(px)
    if dropdownOpenTween then dropdownOpenTween:Cancel() end
    if dropdownCloseTween then dropdownCloseTween:Cancel() end
    dropdownOpenTween = TweenService:Create(dropdownContainer, TweenInfo.new(0.18), {Size = UDim2.new(0, 240, 0, px)})
    dropdownOpenTween:Play()
end

filterBtn.MouseButton1Click:Connect(function()
    if dropdownContainer.Visible then
        -- close
        setDropdownHeight(0)
        task.delay(0.18, function() dropdownContainer.Visible = false end)
    else
        dropdownContainer.Visible = true
        -- limit height to 180 or content size
        local desired = math.clamp(dropdownLayout.AbsoluteContentSize.Y + 6, 40, 180)
        setDropdownHeight(desired)
    end
end)

-- small function to create a player row inside dropdown
local function createPlayerRow(pl)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, -8, 0, 26)
    row.BackgroundTransparency = 1
    row.Parent = dropdownCanvas

    local checkBtn = Instance.new("TextButton")
    checkBtn.Size = UDim2.new(0, 26, 0, 22)
    checkBtn.Position = UDim2.new(0, 4, 0, 2)
    checkBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
    checkBtn.BorderSizePixel = 0
    checkBtn.Text = ""
    checkBtn.Parent = row
    Instance.new("UICorner", checkBtn).CornerRadius = UDim.new(0,4)

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -36, 1, 0)
    nameLabel.Position = UDim2.new(0, 36, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Font = Enum.Font.SourceSans
    nameLabel.TextSize = 14
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Text = pl.DisplayName
    nameLabel.TextColor3 = Color3.fromRGB(230,230,230)
    nameLabel.Parent = row

    -- store username for filtering
    row:SetAttribute("username", pl.Name)

    local function updateCheckVisual(checked)
        if checked then
            checkBtn.Text = "✓"
            checkBtn.TextColor3 = Color3.fromRGB(0,255,0)
        else
            checkBtn.Text = ""
        end
    end

    -- initialize visual to current selectedFilters state
    updateCheckVisual(selectedFilters[pl.Name] == true)

    checkBtn.MouseButton1Click:Connect(function()
        local u = pl.Name
        selectedFilters[u] = not selectedFilters[u]
        updateCheckVisual(selectedFilters[u])
        updateFilterButtonText()
        -- update log visibility
        local anySelected = false
        for _, v in pairs(selectedFilters) do if v then anySelected = true break end end

        for _, child in ipairs(scrollFrame:GetChildren()) do
            if child:IsA("Frame") and child:GetAttribute("username") then
                local un = child:GetAttribute("username")
                if not anySelected then
                    child.Visible = true
                else
                    child.Visible = (selectedFilters[un] == true)
                end
            end
        end
    end)
end

-- populate dropdown with current players
local function refreshDropdownPlayers()
    -- clear (keep UIListLayout)
    for _, c in ipairs(dropdownCanvas:GetChildren()) do
        if not c:IsA("UIListLayout") then c:Destroy() end
    end
    for _, pl in ipairs(Players:GetPlayers()) do
        createPlayerRow(pl)
    end
    -- recalc dropdown height if open
    if dropdownContainer.Visible then
        task.delay(0.03, function()
            local desired = math.clamp(dropdownLayout.AbsoluteContentSize.Y + 6, 40, 180)
            setDropdownHeight(desired)
        end)
    end
end

Players.PlayerAdded:Connect(function(pl)
    refreshDropdownPlayers()
end)
Players.PlayerRemoving:Connect(function(pl)
    -- remove filter if present
    selectedFilters[pl.Name] = nil
    refreshDropdownPlayers()
    updateFilterButtonText()
end)

-- populate initially
refreshDropdownPlayers()

-- Return button
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 24, 0, 24)
returnBtn.Position = UDim2.new(1, -60, 0, 2)
returnBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
returnBtn.BorderSizePixel = 0
returnBtn.Text = "⟳"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 18
returnBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
returnBtn.Parent = header
Instance.new("UICorner", returnBtn).CornerRadius = UDim.new(0, 6)

local spectateLabel = Instance.new("TextLabel")
spectateLabel.Size = UDim2.new(0, 160, 0, 20)
spectateLabel.Position = UDim2.new(0, 110, 0, 4)
spectateLabel.BackgroundTransparency = 1
spectateLabel.Font = Enum.Font.SourceSansItalic
spectateLabel.TextSize = 14
spectateLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
spectateLabel.Text = ""
spectateLabel.TextXAlignment = Enum.TextXAlignment.Left
spectateLabel.Parent = header

local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 20, 0, 20)
hideBtn.Position = UDim2.new(1, -24, 0, 4)
hideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
hideBtn.BorderSizePixel = 0
hideBtn.Text = "v"
hideBtn.Font = Enum.Font.SourceSansBold
hideBtn.TextSize = 14
hideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
hideBtn.Parent = header
Instance.new("UICorner", hideBtn).CornerRadius = UDim.new(0, 6)

local unhideBtn = Instance.new("TextButton")
unhideBtn.Size = UDim2.new(0, 30, 0, 30)
unhideBtn.Position = UDim2.new(0, 10, 0, 10)
unhideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
unhideBtn.BorderSizePixel = 0
unhideBtn.Text = "^"
unhideBtn.Font = Enum.Font.SourceSansBold
unhideBtn.TextSize = 18
unhideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
unhideBtn.Visible = false
unhideBtn.Active = true
unhideBtn.Draggable = true
unhideBtn.Parent = screenGui
Instance.new("UICorner", unhideBtn).CornerRadius = UDim.new(0, 6)

hideBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
        dropdownContainer.Visible = false
        unhideBtn.Visible = true
end)
unhideBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = true
        unhideBtn.Visible = false
end)

local resizeHandle = Instance.new("Frame")
resizeHandle.Size = UDim2.new(0, 20, 0, 20)
resizeHandle.Position = UDim2.new(1, -20, 1, -20)
resizeHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
resizeHandle.BackgroundTransparency = 0.5
resizeHandle.BorderSizePixel = 0
resizeHandle.ZIndex = 2
resizeHandle.Parent = mainFrame
Instance.new("UICorner", resizeHandle).CornerRadius = UDim.new(0, 8)

local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
scrollFrame.BackgroundTransparency = 0.5
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame
Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = scrollFrame

-- New messages indicator
local newMsgBtn = Instance.new("TextButton")
newMsgBtn.Size = UDim2.new(0, 160, 0, 26)
newMsgBtn.AnchorPoint = Vector2.new(0.5, 1)
newMsgBtn.Position = UDim2.new(0.5, 0, 1, -6)
newMsgBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
newMsgBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
newMsgBtn.Font = Enum.Font.SourceSansBold
newMsgBtn.TextSize = 14
newMsgBtn.Text = "New messages below ↓"
newMsgBtn.BorderSizePixel = 0
newMsgBtn.Visible = false
newMsgBtn.Parent = mainFrame
Instance.new("UICorner", newMsgBtn).CornerRadius = UDim.new(0, 6)

local fadeInTween = TweenService:Create(newMsgBtn, TweenInfo.new(0.25), {BackgroundTransparency = 0, TextTransparency = 0})
local fadeOutTween = TweenService:Create(newMsgBtn, TweenInfo.new(0.25), {BackgroundTransparency = 1, TextTransparency = 1})

local function showNewMsgButton()
        if not newMsgBtn.Visible then
                newMsgBtn.Visible = true
                fadeInTween:Play()
        end
end
local function hideNewMsgButton()
        if newMsgBtn.Visible then
                fadeOutTween:Play()
                task.delay(0.25, function() newMsgBtn.Visible = false end)
        end
end
newMsgBtn.MouseButton1Click:Connect(function()
        scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
        hideNewMsgButton()
end)
scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
        local bottomThreshold = layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 20
        if scrollFrame.CanvasPosition.Y >= bottomThreshold then hideNewMsgButton() end
end)

-- Timestamp (12-hour format)
local function formatTimestampUTCplus8()
        local now = os.time()
        local utc8 = os.date("!*t", now + 8 * 3600)
        local hour, min = utc8.hour, utc8.min
        local ampm = (hour >= 12) and "PM" or "AM"
        if hour == 0 then hour = 12 elseif hour > 12 then hour = hour - 12 end
        return string.format("%d:%02d%s", hour, min, ampm)
end

-- Name color cache
local function hashString(s)
        local h = 0
        for i = 1, #s do h = (h * 31 + string.byte(s, i)) % 0xFFFFFFFF end
        return h
end
local function hslToRgb(h, s, l)
        local function hue2rgb(p, q, t)
                if t < 0 then t = t + 1 end
                if t > 1 then t = t - 1 end
                if t < 1/6 then return p + (q - p) * 6 * t end
                if t < 1/2 then return q end
                if t < 2/3 then return p + (q - p) * (2/3 - t) * 6 end
                return p
        end
        local q = l < 0.5 and l * (1 + s) or l + s - l * s
        local p = 2 * l - q
        return Color3.new(hue2rgb(p, q, h + 1/3), hue2rgb(p, q, h), hue2rgb(p, q, h - 1/3))
end
local usernameColorCache = {}
local function getColorForName(name)
        if usernameColorCache[name] then return usernameColorCache[name] end
        local hue = (hashString(name) % 360) / 360
        local color = hslToRgb(hue, 0.55, 0.55)
        usernameColorCache[name] = color
        return color
end

-- Spectate functions
local function spectatePlayer(targetName)
        local target = Players:FindFirstChild(targetName)
        if not target or not target.Character then return end
        local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
                camera.CameraType = Enum.CameraType.Custom
                camera.CameraSubject = humanoid
                spectateLabel.Text = "Spectating: " .. target.DisplayName
        end
end
local function returnToLocal()
        local char = player.Character
        if not char then return end
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
                camera.CameraType = Enum.CameraType.Custom
                camera.CameraSubject = humanoid
                spectateLabel.Text = ""
        end
end
returnBtn.MouseButton1Click:Connect(returnToLocal)

-- Log messages
local function logMessage(text, displayName, username)
        local entry = Instance.new("Frame")
        entry.Size = UDim2.new(1, -10, 0, 0)
        entry.BackgroundTransparency = 1
        entry.AutomaticSize = Enum.AutomaticSize.Y
        entry.Parent = scrollFrame
        entry:SetAttribute("username", username)

        local tsLabel = Instance.new("TextLabel", entry)
        tsLabel.Size = UDim2.new(0, 64, 0, 18)
        tsLabel.BackgroundTransparency = 1
        tsLabel.Font = Enum.Font.Code
        tsLabel.TextSize = 14
        tsLabel.Text = formatTimestampUTCplus8()
        tsLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
        tsLabel.TextXAlignment = Enum.TextXAlignment.Left

        local nameBtn = Instance.new("TextButton", entry)
        nameBtn.Size = UDim2.new(0, 120, 0, 0)
        nameBtn.Position = UDim2.new(0, 70, 0, 0)
        nameBtn.BackgroundTransparency = 1
        nameBtn.AutoButtonColor = false
        nameBtn.Font = Enum.Font.SourceSansBold
        nameBtn.TextSize = 18
        nameBtn.Text = displayName
        nameBtn.TextXAlignment = Enum.TextXAlignment.Left
        nameBtn.TextColor3 = getColorForName(username)
        nameBtn.AutomaticSize = Enum.AutomaticSize.Y
        nameBtn.MouseButton1Click:Connect(function() spectatePlayer(username) end)

        local msgBtn = Instance.new("TextButton", entry)
        msgBtn.Size = UDim2.new(1, -200, 0, 0)
        msgBtn.Position = UDim2.new(0, 200, 0, 0)
        msgBtn.BackgroundTransparency = 1
        msgBtn.Font = Enum.Font.SourceSans
        msgBtn.TextSize = 18
        msgBtn.TextWrapped = true
        msgBtn.TextXAlignment = Enum.TextXAlignment.Left
        msgBtn.AutomaticSize = Enum.AutomaticSize.Y
        msgBtn.Text = text
        msgBtn.TextColor3 = Color3.fromRGB(220, 220, 220)
        msgBtn.AutoButtonColor = true

        -- Make sure the entry carries the username attribute for filtering
        entry:SetAttribute("username", username)

        msgBtn.MouseButton1Click:Connect(function()
                if setclipboard then
                        setclipboard(text)
                        msgBtn.TextColor3 = Color3.fromRGB(0, 255, 0)
                        task.delay(0.5, function() msgBtn.TextColor3 = Color3.fromRGB(220, 220, 220) end)
                end
        end)

        task.defer(function()
                scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)

                -- apply current filter state to the new entry
                local anySelected = false
                for _, v in pairs(selectedFilters) do if v then anySelected = true break end end
                if not anySelected then
                    entry.Visible = true
                else
                    entry.Visible = (selectedFilters[username] == true)
                end

                local nearBottom = scrollFrame.CanvasPosition.Y >= layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 40
                if nearBottom then
                        scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
                else
                        showNewMsgButton()
                end
        end)
end

-- Hook chat
if TextChatService.MessageReceived then
        TextChatService.MessageReceived:Connect(function(message)
                if message.Text and message.TextSource then
                        local userId = message.TextSource.UserId
                        local displayName, username = "[Unknown]", "[Unknown]"
                        if userId then
                                local p = Players:GetPlayerByUserId(userId)
                                if p then
                                        displayName = p.DisplayName
                                        username = p.Name
                                end
                        end
                        logMessage(message.Text, displayName, username)
                end
        end)
else
        -- fallback to Player.Chatted
        for _, p in ipairs(Players:GetPlayers()) do
                p.Chatted:Connect(function(msg)
                        logMessage(msg, p.DisplayName, p.Name)
                end)
        end
        Players.PlayerAdded:Connect(function(p)
                p.Chatted:Connect(function(msg)
                        logMessage(msg, p.DisplayName, p.Name)
                end)
        end)
end