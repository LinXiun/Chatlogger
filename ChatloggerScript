-- Chat Logger LocalScript (TextChatService + fallback to Player.Chatted)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Create GUI root
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main frame (kept compact here; unchanged from previous)
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 420, 0, 360)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.5
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
local mainCorner = Instance.new("UICorner", mainFrame)
mainCorner.CornerRadius = UDim.new(0, 8)

-- Header
local header = Instance.new("Frame", mainFrame)
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
local title = Instance.new("TextLabel", header)
title.Size = UDim2.new(1, -120, 1, 0)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger"
title.TextColor3 = Color3.fromRGB(220, 220, 220)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left

local spectateLabel = Instance.new("TextLabel", header)
spectateLabel.Size = UDim2.new(0, 160, 1, 0)
spectateLabel.Position = UDim2.new(0, 110, 0, 0)
spectateLabel.BackgroundTransparency = 1
spectateLabel.Font = Enum.Font.SourceSansItalic
spectateLabel.TextSize = 14
spectateLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
spectateLabel.Text = ""
spectateLabel.TextXAlignment = Enum.TextXAlignment.Left

local returnBtn = Instance.new("TextButton", header)
returnBtn.Size = UDim2.new(0, 96, 0, 20)
returnBtn.Position = UDim2.new(1, -104, 0, 4)
returnBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
returnBtn.BorderSizePixel = 0
returnBtn.Text = "Return to Me"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 14
returnBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
local returnCorner = Instance.new("UICorner", returnBtn)
returnCorner.CornerRadius = UDim.new(0, 6)

-- Resize handle
local resizeHandle = Instance.new("Frame", mainFrame)
resizeHandle.Size = UDim2.new(0, 20, 0, 20)
resizeHandle.Position = UDim2.new(1, -20, 1, -20)
resizeHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
resizeHandle.BackgroundTransparency = 0.5
resizeHandle.BorderSizePixel = 0
resizeHandle.AnchorPoint = Vector2.new(0, 0)
resizeHandle.ZIndex = 999
local resizeCorner = Instance.new("UICorner", resizeHandle)
resizeCorner.CornerRadius = UDim.new(0, 8)

-- Scrolling frame and layout
local scrollFrame = Instance.new("ScrollingFrame", mainFrame)
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundTransparency = 0.5
scrollFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0,0,0,0)
scrollFrame.ScrollBarThickness = 6
local scrollCorner = Instance.new("UICorner", scrollFrame)
scrollCorner.CornerRadius = UDim.new(0,8)
local layout = Instance.new("UIListLayout", scrollFrame)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0,6)

-- Utilities (timestamps, colors)
local function formatTimestampUTCplus8()
	local now = os.time()
	local utc8 = os.date("!*t", now + 8 * 3600)
	return string.format("%02d:%02d:%02d", utc8.hour, utc8.min, utc8.sec)
end

local function hashString(s)
	local h = 0
	for i = 1, #s do
		h = (h * 31 + string.byte(s, i)) % 0xFFFFFFFF
	end
	return h
end

local function hslToRgb(h, s, l)
	local function hue2rgb(p, q, t)
		if t < 0 then t = t + 1 end
		if t > 1 then t = t - 1 end
		if t < 1/6 then return p + (q - p) * 6 * t end
		if t < 1/2 then return q end
		if t < 2/3 then return p + (q - p) * (2/3 - t) * 6 end
		return p
	end
	if s == 0 then return Color3.new(l,l,l) end
	local q = l < 0.5 and l * (1 + s) or l + s - l * s
	local p = 2 * l - q
	local r = hue2rgb(p,q,h + 1/3)
	local g = hue2rgb(p,q,h)
	local b = hue2rgb(p,q,h - 1/3)
	return Color3.new(r,g,b)
end

local usernameColorCache = {}
local function getColorForName(name)
	if usernameColorCache[name] then return usernameColorCache[name] end
	local hval = hashString(name)
	local hue = (hval % 360) / 360
	local color = hslToRgb(hue, 0.56, 0.52)
	usernameColorCache[name] = color
	return color
end

-- Spectate and return functions
local function spectatePlayer(targetName)
	local target = Players:FindFirstChild(targetName)
	if not target or not target.Character then return end
	local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
	if humanoid then
		pcall(function()
			camera.CameraType = Enum.CameraType.Custom
			camera.CameraSubject = humanoid
			spectateLabel.Text = "Spectating: " .. targetName
		end)
	end
end

local function returnToLocal()
	local char = player.Character
	if not char then return end
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if humanoid then
		pcall(function()
			camera.CameraType = Enum.CameraType.Custom
			camera.CameraSubject = humanoid
			spectateLabel.Text = ""
		end)
	end
end
returnBtn.MouseButton1Click:Connect(returnToLocal)

-- Resize logic (robust)
resizeHandle.Active = true
resizeHandle.InputTransparency = 0
local resizing = false
local startMousePos = Vector2.new()
local startSize = Vector2.new()
local minWidth, minHeight = 240, 140
local function stopResizing() resizing = false end

resizeHandle.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		resizing = true
		startMousePos = UserInputService:GetMouseLocation()
		startSize = Vector2.new(mainFrame.AbsoluteSize.X, mainFrame.AbsoluteSize.Y)
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then stopResizing() end
		end)
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if not resizing then return end
	if input.UserInputType ~= Enum.UserInputType.MouseMovement and input.UserInputType ~= Enum.UserInputType.Touch then return end
	local current = UserInputService:GetMouseLocation()
	local delta = current - startMousePos
	local newX = math.max(minWidth, math.floor(startSize.X + delta.X + 0.5))
	local newY = math.max(minHeight, math.floor(startSize.Y + delta.Y + 0.5))
	mainFrame.Size = UDim2.new(0, newX, 0, newY)
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then stopResizing() end
end)

-- Logging function
local function logMessage(text, authorName)
	if not text or text == "" then return end
	local entry = Instance.new("Frame")
	entry.Size = UDim2.new(1, -10, 0, 0)
	entry.BackgroundTransparency = 1
	entry.BorderSizePixel = 0
	entry.LayoutOrder = layout.AbsoluteContentSize.Y + 1
	entry.AutomaticSize = Enum.AutomaticSize.Y
	entry.Parent = scrollFrame

	local pad = Instance.new("UIPadding", entry)
	pad.PaddingLeft = UDim.new(0, 6)
	pad.PaddingRight = UDim.new(0, 6)
	pad.PaddingTop = UDim.new(0, 2)
	pad.PaddingBottom = UDim.new(0, 2)

	local tsLabel = Instance.new("TextLabel", entry)
	tsLabel.Size = UDim2.new(0, 64, 0, 18)
	tsLabel.BackgroundTransparency = 1
	tsLabel.Font = Enum.Font.Code
	tsLabel.TextSize = 14
	tsLabel.Text = formatTimestampUTCplus8()
	tsLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
	tsLabel.TextXAlignment = Enum.TextXAlignment.Left
	tsLabel.TextYAlignment = Enum.TextYAlignment.Center

	local nameBtn = Instance.new("TextButton", entry)
	nameBtn.Size = UDim2.new(0, 120, 0, 0)
	nameBtn.Position = UDim2.new(0, 70, 0, 0)
	nameBtn.BackgroundTransparency = 1
	nameBtn.AutoButtonColor = false
	nameBtn.Font = Enum.Font.SourceSansBold
	nameBtn.TextSize = 18
	nameBtn.Text = authorName
	nameBtn.TextXAlignment = Enum.TextXAlignment.Left
	nameBtn.AutomaticSize = Enum.AutomaticSize.Y
	nameBtn.TextColor3 = getColorForName(authorName)
	nameBtn.MouseButton1Click:Connect(function() spectatePlayer(authorName) end)

	local msgLabel = Instance.new("TextLabel", entry)
	msgLabel.Size = UDim2.new(1, -200, 0, 0)
	msgLabel.Position = UDim2.new(0, 200, 0, 0)
	msgLabel.BackgroundTransparency = 1
	msgLabel.Font = Enum.Font.SourceSans
	msgLabel.TextSize = 18
	msgLabel.TextWrapped = true
	msgLabel.TextXAlignment = Enum.TextXAlignment.Left
	msgLabel.TextYAlignment = Enum.TextYAlignment.Top
	msgLabel.AutomaticSize = Enum.AutomaticSize.Y
	msgLabel.Text = text
	msgLabel.TextColor3 = Color3.fromRGB(220, 220, 220)

	local sep = Instance.new("Frame", entry)
	sep.Size = UDim2.new(1, 0, 0, 1)
	sep.Position = UDim2.new(0, 0, 1, -2)
	sep.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	sep.BorderSizePixel = 0

	task.defer(function()
		scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
		scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
	end)
end

-- Helper: invoke the same logger for TextChatService (modern) and Player.Chatted (legacy)
local function handleTextChatMessage(message)
	if not message then return end
	if message.Text and message.TextSource then
		local author = tostring(message.TextSource.Name)
		if message.TextSource.UserId and message.TextSource.UserId > 0 then
			local p = Players:GetPlayerByUserId(message.TextSource.UserId)
			if p then author = p.Name end
		end
		logMessage(message.Text, author)
	end
end

-- Modern TextChatService listener (connect safely)
if TextChatService and TextChatService.OnIncomingMessage then
	local ok, err = pcall(function()
		TextChatService.OnIncomingMessage:Connect(handleTextChatMessage)
	end)
	-- ignore errors; fallback listeners below will still catch messages
end

-- Legacy fallback: Player.Chatted for existing players and future players
local function connectPlayerChatted(p)
	if not p then return end
	p.Chatted:Connect(function(msg)
		-- p.Name is canonical username
		logMessage(msg, p.Name)
	end)
end

-- connect current players
for _, p in ipairs(Players:GetPlayers()) do
	connectPlayerChatted(p)
end
-- connect future players
Players.PlayerAdded:Connect(connectPlayerChatted)

-- Restore camera to local player when respawning
player.CharacterAdded:Connect(function()
	task.wait(0.1)
	local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
	if humanoid then
		pcall(function()
			camera.CameraType = Enum.CameraType.Custom
			camera.CameraSubject = humanoid
			spectateLabel.Text = ""
		end)
	end
end)