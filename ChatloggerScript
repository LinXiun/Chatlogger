--// ChatLogger.lua
--// One-script Chat Logger (Draggable, Scroll Button, Dropdown Filter)
--// Place inside StarterPlayerScripts

--------------------------------------------------
-- Setup
--------------------------------------------------
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local REMOTE_NAME = "ChatLoggerEvent"
local chatEvent = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
if not chatEvent then
	chatEvent = Instance.new("RemoteEvent")
	chatEvent.Name = REMOTE_NAME
	chatEvent.Parent = ReplicatedStorage
end

--------------------------------------------------
-- Server logic
--------------------------------------------------
if not RunService:IsClient() then
	local function broadcast(name, msg)
		chatEvent:FireAllClients({
			player = name,
			message = msg,
			time = os.time()
		})
	end

	local function onPlayerAdded(plr)
		plr.Chatted:Connect(function(msg)
			broadcast(plr.Name, msg)
		end)
	end

	for _, p in ipairs(Players:GetPlayers()) do onPlayerAdded(p) end
	Players.PlayerAdded:Connect(onPlayerAdded)
	return
end

--------------------------------------------------
-- Client logic
--------------------------------------------------
local LocalPlayer = Players.LocalPlayer

local function New(class, props)
	local inst = Instance.new(class)
	for k, v in pairs(props or {}) do inst[k] = v end
	return inst
end

local function stringToColor(name)
	local hash = 0
	for i = 1, #name do
		hash = (hash + string.byte(name, i) * i) % 0xFFFFFF
	end
	local r = (hash % 256) / 255
	local g = ((hash // 256) % 256) / 255
	local b = ((hash // 65536) % 256) / 255
	return Color3.new(r, g, b)
end

local function formatTime(epoch)
	local t = os.date("*t", epoch)
	return string.format("%02d:%02d:%02d", t.hour, t.min, t.sec)
end

--------------------------------------------------
-- GUI Setup
--------------------------------------------------
local gui = New("ScreenGui", {
	Name = "ChatLoggerGUI",
	Parent = LocalPlayer:WaitForChild("PlayerGui"),
	ResetOnSpawn = false
})

local main = New("Frame", {
	Parent = gui,
	AnchorPoint = Vector2.new(0, 1),
	Position = UDim2.new(0.02, 0, 0.98, 0),
	Size = UDim2.new(0, 440, 0, 380),
	BackgroundColor3 = Color3.fromRGB(28, 30, 33)
})
New("UICorner", {Parent = main, CornerRadius = UDim.new(0, 12)})

local header = New("Frame", {
	Parent = main,
	Size = UDim2.new(1, 0, 0, 40),
	BackgroundTransparency = 1
})

New("TextLabel", {
	Parent = header,
	Text = "Chat Logger",
	Font = Enum.Font.GothamSemibold,
	TextSize = 18,
	TextColor3 = Color3.fromRGB(235, 235, 235),
	BackgroundTransparency = 1,
	Position = UDim2.new(0.02, 0, 0, 0),
	Size = UDim2.new(0.4, 0, 1, 0),
	TextXAlignment = Enum.TextXAlignment.Left
})

-- Helper: button creator
local function CreateButton(label, offset)
	local btn = New("TextButton", {
		Text = label,
		Font = Enum.Font.Gotham,
		TextSize = 14,
		TextColor3 = Color3.fromRGB(235, 235, 235),
		Size = UDim2.new(0, 70, 0, 28),
		Position = UDim2.new(1, -offset, 0, 6),
		BackgroundColor3 = Color3.fromRGB(55, 57, 60)
	})
	New("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 8)})
	return btn
end

local clearBtn = CreateButton("Clear", 80)
clearBtn.Parent = header

local exportBtn = CreateButton("Export", 160)
exportBtn.Parent = header

-- Dropdown filter
local dropdownBtn = New("TextButton", {
	Parent = header,
	Text = "Filter: All",
	Font = Enum.Font.Gotham,
	TextSize = 14,
	TextColor3 = Color3.fromRGB(230, 230, 230),
	Size = UDim2.new(0, 150, 0, 28),
	Position = UDim2.new(0.42, 0, 0, 6),
	BackgroundColor3 = Color3.fromRGB(40, 42, 45)
})
New("UICorner", {Parent = dropdownBtn, CornerRadius = UDim.new(0, 8)})

local dropdownList = New("Frame", {
	Parent = main,
	BackgroundColor3 = Color3.fromRGB(40, 42, 45),
	Visible = false,
	Size = UDim2.new(0, 180, 0, 0),
	Position = UDim2.new(0.42, 0, 0.12, 0),
	ClipsDescendants = true
})
New("UICorner", {Parent = dropdownList, CornerRadius = UDim.new(0, 10)})
New("UIListLayout", {Parent = dropdownList, Padding = UDim.new(0, 4)})

-- Scroll area
local scroll = New("ScrollingFrame", {
	Parent = main,
	Position = UDim2.new(0.02, 0, 0.12, 0),
	Size = UDim2.new(0.96, 0, 0.84, 0),
	BackgroundTransparency = 1,
	ScrollBarThickness = 8,
	VerticalScrollBarInset = Enum.ScrollBarInset.ScrollBar
})
local list = New("UIListLayout", {Parent = scroll, Padding = UDim.new(0, 6)})

-- Scroll-to-bottom button
local scrollBtn = New("TextButton", {
	Parent = main,
	Text = "Scroll ↓",
	Font = Enum.Font.Gotham,
	TextSize = 14,
	TextColor3 = Color3.fromRGB(235, 235, 235),
	Size = UDim2.new(0, 90, 0, 28),
	Position = UDim2.new(1, -100, 1, -36),
	BackgroundColor3 = Color3.fromRGB(55, 57, 60)
})
New("UICorner", {Parent = scrollBtn, CornerRadius = UDim.new(0, 8)})

--------------------------------------------------
-- Functionality
--------------------------------------------------
local logs = {}
local selectedPlayers = {}
local dropdownOpen = false

local function addMessage(entry)
	table.insert(logs, entry)
	if next(selectedPlayers) and not selectedPlayers[entry.player] then return end

	local line = New("TextLabel", {
		Parent = scroll,
		BackgroundColor3 = Color3.fromRGB(47, 49, 52),
		TextColor3 = Color3.fromRGB(230, 230, 230),
		TextWrapped = true,
		TextXAlignment = Enum.TextXAlignment.Left,
		TextYAlignment = Enum.TextYAlignment.Top,
		Font = Enum.Font.Gotham,
		TextSize = 14,
		Size = UDim2.new(1, -10, 0, 0)
	})
	New("UICorner", {Parent = line, CornerRadius = UDim.new(0, 8)})

	local playerColor = stringToColor(entry.player)
	line.RichText = true
	line.Text = string.format(
		"[%s] <font color=\"rgb(%d,%d,%d)\">%s</font>: %s",
		formatTime(entry.time),
		math.floor(playerColor.R * 255),
		math.floor(playerColor.G * 255),
		math.floor(playerColor.B * 255),
		entry.player,
		entry.message
	)

	line:GetPropertyChangedSignal("TextBounds"):Connect(function()
		line.Size = UDim2.new(1, -10, 0, line.TextBounds.Y + 12)
		scroll.CanvasSize = UDim2.new(0, 0, 0, list.AbsoluteContentSize.Y + 10)
	end)
	line.Text = line.Text
end

-- Scroll button
scrollBtn.MouseButton1Click:Connect(function()
	scroll.CanvasPosition = Vector2.new(0, math.max(0, scroll.CanvasSize.Y.Offset))
end)

-- Dropdown logic
local function rebuildDropdown()
	for _, c in ipairs(dropdownList:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end

	local allBtn = New("TextButton", {
		Parent = dropdownList,
		Text = "All players",
		Font = Enum.Font.Gotham,
		TextSize = 14,
		TextColor3 = Color3.fromRGB(230, 230, 230),
		BackgroundTransparency = 1
	})
	allBtn.MouseButton1Click:Connect(function()
		selectedPlayers = {}
		dropdownBtn.Text = "Filter: All"
		scroll:ClearAllChildren()
		list.Parent = scroll
		for _, e in ipairs(logs) do addMessage(e) end
	end)

	for _, p in ipairs(Players:GetPlayers()) do
		local name = p.Name
		local btn = New("TextButton", {
			Parent = dropdownList,
			Text = (selectedPlayers[name] and "☑ " or "☐ ") .. name,
			Font = Enum.Font.Gotham,
			TextSize = 14,
			TextColor3 = Color3.fromRGB(230, 230, 230),
			BackgroundTransparency = 1
		})
		btn.MouseButton1Click:Connect(function()
			selectedPlayers[name] = not selectedPlayers[name] or nil
			rebuildDropdown()
			local count = 0 for _ in pairs(selectedPlayers) do count += 1 end
			dropdownBtn.Text = count == 0 and "Filter: All" or ("Filter: " .. count .. " selected")
			scroll:ClearAllChildren()
			list.Parent = scroll
			for _, e in ipairs(logs) do addMessage(e) end
		end)
	end
end

local function toggleDropdown()
	dropdownOpen = not dropdownOpen
	if dropdownOpen then
		rebuildDropdown()
		dropdownList.Visible = true
		local height = math.clamp((#Players:GetPlayers() + 1) * 28 + 8, 80, 220)
		dropdownList:TweenSize(UDim2.new(0, 180, 0, height), "Out", "Quad", 0.15, true)
	else
		dropdownList:TweenSize(UDim2.new(0, 180, 0, 0), "Out", "Quad", 0.15, true)
		task.delay(0.16, function() dropdownList.Visible = false end)
	end
end
dropdownBtn.MouseButton1Click:Connect(toggleDropdown)

Players.PlayerAdded:Connect(function() if dropdownOpen then rebuildDropdown() end end)
Players.PlayerRemoving:Connect(function() if dropdownOpen then rebuildDropdown() end end)

-- Clear
clearBtn.MouseButton1Click:Connect(function()
	logs = {}
	scroll:ClearAllChildren()
	list.Parent = scroll
end)

-- Export
exportBtn.MouseButton1Click:Connect(function()
	local modal = New("Frame", {
		Parent = gui,
		Size = UDim2.new(0.8, 0, 0.7, 0),
		Position = UDim2.new(0.1, 0, 0.15, 0),
		BackgroundColor3 = Color3.fromRGB(26, 28, 30)
	})
	New("UICorner", {Parent = modal, CornerRadius = UDim.new(0, 12)})

	local closeBtn = CreateButton("Close", 20)
	closeBtn.Parent = modal
	closeBtn.Position = UDim2.new(1, -80, 0, 8)

	local box = New("TextBox", {
		Parent = modal,
		MultiLine = true,
		ClearTextOnFocus = false,
		TextWrapped = true,
		TextXAlignment = Enum.TextXAlignment.Left,
		TextYAlignment = Enum.TextYAlignment.Top,
		Font = Enum.Font.Gotham,
		TextSize = 14,
		BackgroundColor3 = Color3.fromRGB(20, 22, 24),
		TextColor3 = Color3.fromRGB(230, 230, 230),
		Size = UDim2.new(1, -20, 1, -50),
		Position = UDim2.new(0, 10, 0, 40)
	})
	New("UICorner", {Parent = box, CornerRadius = UDim.new(0, 8)})

	closeBtn.MouseButton1Click:Connect(function() modal:Destroy() end)

	local text = {}
	for _, e in ipairs(logs) do
		table.insert(text, string.format("[%s] %s: %s", formatTime(e.time), e.player, e.message))
	end
	box.Text = table.concat(text, "\n")
end)

--------------------------------------------------
-- Dragging Logic
--------------------------------------------------
local UIS = game:GetService("UserInputService")
local dragging = false
local dragStart, startPos

header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = main.Position
	end
end)

header.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
		local delta = input.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

UIS.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

--------------------------------------------------
-- Chat listener
--------------------------------------------------
chatEvent.OnClientEvent:Connect(function(data)
	addMessage(data)
end)