--// Chat Logger with Spectate System (DisplayNames, Manual Scroll, Indicator, 12hr Time)
--// Made for LocalScript inside StarterGui

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TextChatService = game:GetService("TextChatService")

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChatLogger"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0.4, 0, 0.5, 0)
mainFrame.Position = UDim2.new(0.3, 0, 0.25, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = ScreenGui

-- UI Corner + Stroke
Instance.new("UICorner", mainFrame)
local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Color = Color3.fromRGB(60, 60, 60)
stroke.Parent = mainFrame

-- Title Bar
local titleBar = Instance.new("TextLabel")
titleBar.Size = UDim2.new(1, -30, 0, 28)
titleBar.Position = UDim2.new(0, 5, 0, 0)
titleBar.BackgroundTransparency = 1
titleBar.Text = "Chat Logger"
titleBar.Font = Enum.Font.SourceSansSemibold
titleBar.TextSize = 20
titleBar.TextColor3 = Color3.fromRGB(255, 255, 255)
titleBar.TextXAlignment = Enum.TextXAlignment.Left
titleBar.Parent = mainFrame

-- Return button (small symbol only)
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 26, 0, 26)
returnBtn.Position = UDim2.new(1, -28, 0, 1)
returnBtn.BackgroundTransparency = 1
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 18
returnBtn.Text = "â†©"
returnBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
returnBtn.Parent = mainFrame

-- Scroll Frame
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -8, 1, -34)
scrollFrame.Position = UDim2.new(0, 4, 0, 30)
scrollFrame.BackgroundTransparency = 1
scrollFrame.ScrollBarThickness = 6
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
scrollFrame.CanvasSize = UDim2.new()
scrollFrame.Parent = mainFrame

local layout = Instance.new("UIListLayout", scrollFrame)
layout.Padding = UDim.new(0, 3)
layout.SortOrder = Enum.SortOrder.LayoutOrder

-- Indicator at bottom middle
local indicator = Instance.new("TextLabel")
indicator.AnchorPoint = Vector2.new(0.5, 1)
indicator.Position = UDim2.new(0.5, 0, 1, -6)
indicator.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
indicator.Size = UDim2.new(0, 100, 0, 24)
indicator.Text = "Idle"
indicator.Font = Enum.Font.SourceSans
indicator.TextSize = 16
indicator.TextColor3 = Color3.fromRGB(200, 200, 200)
indicator.Visible = false
indicator.Parent = mainFrame
Instance.new("UICorner", indicator)

-- Spectate system
local camera = workspace.CurrentCamera
local spectating = false
local spectateTarget

local function spectatePlayer(playerName)
    local target = Players:FindFirstChild(playerName)
    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
        spectating = true
        spectateTarget = target
        indicator.Text = "Spectating " .. target.DisplayName
        indicator.Visible = true
        task.spawn(function()
            while spectating and spectateTarget == target do
                camera.CameraSubject = target.Character:FindFirstChildWhichIsA("Humanoid")
                task.wait()
            end
        end)
    end
end

returnBtn.MouseButton1Click:Connect(function()
    spectating = false
    spectateTarget = nil
    indicator.Text = "Idle"
    indicator.Visible = false
    camera.CameraSubject = LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
end)

-- Timestamp (12-hour format, compressed)
local function formatTimestampUTCplus8()
    local time = os.date("!*t", os.time() + (8 * 3600))
    local hour = time.hour % 12
    if hour == 0 then hour = 12 end
    local ampm = (time.hour >= 12) and "PM" or "AM"
    return string.format("%02d:%02d%s", hour, time.min, ampm)
end

-- Color generator per user
local function getColorForName(name)
    local hash = 0
    for i = 1, #name do
        hash = (hash + string.byte(name, i) * i) % 255
    end
    return Color3.fromHSV((hash / 255), 0.6, 1)
end

-- Log Message
local function logMessage(text, displayName, username)
    local entry = Instance.new("Frame")
    entry.BackgroundTransparency = 1
    entry.Size = UDim2.new(1, -10, 0, 0)
    entry.AutomaticSize = Enum.AutomaticSize.Y
    entry.Parent = scrollFrame

    local tsLabel = Instance.new("TextLabel", entry)
    tsLabel.BackgroundTransparency = 1
    tsLabel.Font = Enum.Font.Code
    tsLabel.TextSize = 14
    tsLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    tsLabel.Text = formatTimestampUTCplus8()
    tsLabel.TextXAlignment = Enum.TextXAlignment.Left
    tsLabel.Size = UDim2.new(0, 52, 0, 18)

    local nameBtn = Instance.new("TextButton", entry)
    nameBtn.BackgroundTransparency = 1
    nameBtn.AutoButtonColor = false
    nameBtn.Font = Enum.Font.SourceSansBold
    nameBtn.TextSize = 18
    nameBtn.Text = displayName
    nameBtn.TextColor3 = getColorForName(username)
    nameBtn.TextXAlignment = Enum.TextXAlignment.Left
    nameBtn.Position = UDim2.new(0, 58, 0, -1)
    nameBtn.Size = UDim2.new(0, 120, 0, 0)
    nameBtn.AutomaticSize = Enum.AutomaticSize.Y
    nameBtn.MouseButton1Click:Connect(function()
        spectatePlayer(username)
    end)

    local msgLabel = Instance.new("TextLabel", entry)
    msgLabel.BackgroundTransparency = 1
    msgLabel.Font = Enum.Font.SourceSans
    msgLabel.TextSize = 18
    msgLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    msgLabel.TextWrapped = true
    msgLabel.TextXAlignment = Enum.TextXAlignment.Left
    msgLabel.TextYAlignment = Enum.TextYAlignment.Top
    msgLabel.Position = UDim2.new(0, 190, 0, 0)
    msgLabel.Size = UDim2.new(1, -200, 0, 0)
    msgLabel.AutomaticSize = Enum.AutomaticSize.Y
    msgLabel.Text = text
end

-- Chat connections
if TextChatService.MessageReceived then
    TextChatService.MessageReceived:Connect(function(message)
        if message.Text and message.TextSource then
            local userId = message.TextSource.UserId
            local displayName, username = "[Unknown]", "[Unknown]"
            if userId then
                local p = Players:GetPlayerByUserId(userId)
                if p then
                    displayName = p.DisplayName
                    username = p.Name
                end
            end
            logMessage(message.Text, displayName, username)
        end
    end)
else
    Players.PlayerAdded:Connect(function(p)
        p.Chatted:Connect(function(msg)
            logMessage(msg, p.DisplayName, p.Name)
        end)
    end)
    for _, p in ipairs(Players:GetPlayers()) do
        p.Chatted:Connect(function(msg)
            logMessage(msg, p.DisplayName, p.Name)
        end)
    end
end