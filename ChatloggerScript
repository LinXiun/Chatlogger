-- Chat Logger GUI (Transparent, Filterable, Draggable, Spectate, Teleport, 8px Rounded)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- ðŸ§± GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatLoggerGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.6
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundTransparency = 1
header.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -140, 1, 0)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Chat Logger"
title.TextColor3 = Color3.fromRGB(220, 220, 220)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Return Button
local returnBtn = Instance.new("TextButton")
returnBtn.Size = UDim2.new(0, 24, 0, 24)
returnBtn.Position = UDim2.new(1, -60, 0, 2)
returnBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
returnBtn.BackgroundTransparency = 0.4
returnBtn.BorderSizePixel = 0
returnBtn.Text = "âŸ³"
returnBtn.Font = Enum.Font.SourceSansBold
returnBtn.TextSize = 18
returnBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
returnBtn.Parent = header
Instance.new("UICorner", returnBtn).CornerRadius = UDim.new(0, 8)

-- Spectate Label
local spectateLabel = Instance.new("TextLabel")
spectateLabel.Size = UDim2.new(0, 160, 0, 20)
spectateLabel.Position = UDim2.new(0, 110, 0, 4)
spectateLabel.BackgroundTransparency = 1
spectateLabel.Font = Enum.Font.SourceSansItalic
spectateLabel.TextSize = 14
spectateLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
spectateLabel.Text = ""
spectateLabel.TextXAlignment = Enum.TextXAlignment.Left
spectateLabel.Parent = header

-- Hide/Unhide Buttons
local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 20, 0, 20)
hideBtn.Position = UDim2.new(1, -24, 0, 4)
hideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
hideBtn.BackgroundTransparency = 0.4
hideBtn.BorderSizePixel = 0
hideBtn.Text = "v"
hideBtn.Font = Enum.Font.SourceSansBold
hideBtn.TextSize = 14
hideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
hideBtn.Parent = header
Instance.new("UICorner", hideBtn).CornerRadius = UDim.new(0, 8)

local unhideBtn = Instance.new("TextButton")
unhideBtn.Size = UDim2.new(0, 30, 0, 30)
unhideBtn.Position = UDim2.new(0, 10, 0, 10)
unhideBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
unhideBtn.BackgroundTransparency = 0.4
unhideBtn.BorderSizePixel = 0
unhideBtn.Text = "^"
unhideBtn.Font = Enum.Font.SourceSansBold
unhideBtn.TextSize = 18
unhideBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
unhideBtn.Visible = false
unhideBtn.Active = true
unhideBtn.Draggable = true
unhideBtn.Parent = screenGui
Instance.new("UICorner", unhideBtn).CornerRadius = UDim.new(0, 8)

hideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
	unhideBtn.Visible = true
end)
unhideBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = true
	unhideBtn.Visible = false
end)

-- Dropdown Panel (Player Filter)
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(0, 120, 1, -36)
dropdownFrame.Position = UDim2.new(0, -124, 0, 36)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
dropdownFrame.BackgroundTransparency = 0.6
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Visible = false
dropdownFrame.Parent = mainFrame
Instance.new("UICorner", dropdownFrame).CornerRadius = UDim.new(0, 8)

local dropdownScroll = Instance.new("ScrollingFrame")
dropdownScroll.Size = UDim2.new(1, 0, 1, 0)
dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdownScroll.BackgroundTransparency = 1
dropdownScroll.BorderSizePixel = 0
dropdownScroll.ScrollBarThickness = 6
dropdownScroll.Parent = dropdownFrame

local dropdownLayout = Instance.new("UIListLayout")
dropdownLayout.Parent = dropdownScroll
dropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
dropdownLayout.Padding = UDim.new(0, 2)

-- Dropdown Toggle Button (+)
local dropdownBtn = Instance.new("TextButton")
dropdownBtn.Size = UDim2.new(0, 24, 0, 24)
dropdownBtn.Position = UDim2.new(1, -90, 0, 2)
dropdownBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
dropdownBtn.BackgroundTransparency = 0.4
dropdownBtn.BorderSizePixel = 0
dropdownBtn.Text = "+"
dropdownBtn.Font = Enum.Font.SourceSansBold
dropdownBtn.TextSize = 18
dropdownBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
dropdownBtn.Parent = header
Instance.new("UICorner", dropdownBtn).CornerRadius = UDim.new(0, 8)

local dropdownOpen = false
dropdownBtn.MouseButton1Click:Connect(function()
	dropdownOpen = not dropdownOpen
	dropdownFrame.Visible = dropdownOpen
	local tween = TweenService:Create(mainFrame, TweenInfo.new(0.25),
		{Position = dropdownOpen and UDim2.new(0, 134, 0, 10) or UDim2.new(0, 10, 0, 10)})
	tween:Play()
end)

-- Chat Frame
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -36)
scrollFrame.Position = UDim2.new(0, 0, 0, 36)
scrollFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
scrollFrame.BackgroundTransparency = 0.6
scrollFrame.BorderSizePixel = 0
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame
Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 4)
layout.Parent = scrollFrame

-- â€œNew messages belowâ€ button
local newMsgBtn = Instance.new("TextButton")
newMsgBtn.Size = UDim2.new(0, 160, 0, 26)
newMsgBtn.AnchorPoint = Vector2.new(0.5, 1)
newMsgBtn.Position = UDim2.new(0.5, 0, 1, -6)
newMsgBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
newMsgBtn.BackgroundTransparency = 0.4
newMsgBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
newMsgBtn.Font = Enum.Font.SourceSansBold
newMsgBtn.TextSize = 14
newMsgBtn.Text = "New messages below â†“"
newMsgBtn.BorderSizePixel = 0
newMsgBtn.Visible = false
newMsgBtn.Parent = mainFrame
Instance.new("UICorner", newMsgBtn).CornerRadius = UDim.new(0, 8)

local fadeInTween = TweenService:Create(newMsgBtn, TweenInfo.new(0.25), {BackgroundTransparency = 0.2})
local fadeOutTween = TweenService:Create(newMsgBtn, TweenInfo.new(0.25), {BackgroundTransparency = 1})

local function showNewMsgButton()
	if not newMsgBtn.Visible then
		newMsgBtn.Visible = true
		fadeInTween:Play()
	end
end
local function hideNewMsgButton()
	if newMsgBtn.Visible then
		fadeOutTween:Play()
		task.delay(0.25, function() newMsgBtn.Visible = false end)
	end
end
newMsgBtn.MouseButton1Click:Connect(function()
	scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
	hideNewMsgButton()
end)
scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
	local bottomThreshold = layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 20
	if scrollFrame.CanvasPosition.Y >= bottomThreshold then hideNewMsgButton() end
end)

-- Timestamp
local function formatTimestampUTCplus8()
	local now = os.time()
	local utc8 = os.date("!*t", now + 8 * 3600)
	local hour, min = utc8.hour, utc8.min
	local ampm = (hour >= 12) and "PM" or "AM"
	if hour == 0 then hour = 12 elseif hour > 12 then hour = hour - 12 end
	return string.format("%d:%02d%s", hour, min, ampm)
end

-- Color per username
local function hashString(s)
	local h = 0
	for i = 1, #s do h = (h * 31 + string.byte(s, i)) % 0xFFFFFFFF end
	return h
end
local function hslToRgb(h, s, l)
	local function hue2rgb(p, q, t)
		if t < 0 then t += 1 end
		if t > 1 then t -= 1 end
		if t < 1/6 then return p + (q - p) * 6 * t end
		if t < 1/2 then return q end
		if t < 2/3 then return p + (q - p) * (2/3 - t) * 6 end
		return p
	end
	local q = l < 0.5 and l * (1 + s) or l + s - l * s
	local p = 2 * l - q
	return Color3.new(hue2rgb(p, q, h + 1/3), hue2rgb(p, q, h), hue2rgb(p, q, h - 1/3))
end
local usernameColorCache = {}
local function getColorForName(name)
	if usernameColorCache[name] then return usernameColorCache[name] end
	local hue = (hashString(name) % 360) / 360
	local color = hslToRgb(hue, 0.55, 0.55)
	usernameColorCache[name] = color
	return color
end

-- Spectate & Return
local function spectatePlayer(targetName)
	local target = Players:FindFirstChild(targetName)
	if not target or not target.Character then return end
	local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
	if humanoid then
		camera.CameraType = Enum.CameraType.Custom
		camera.CameraSubject = humanoid
		spectateLabel.Text = "Spectating: " .. target.DisplayName
	end
end
local function returnToLocal()
	local char = player.Character
	if not char then return end
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if humanoid then
		camera.CameraType = Enum.CameraType.Custom
		camera.CameraSubject = humanoid
		spectateLabel.Text = ""
	end
end
returnBtn.MouseButton1Click:Connect(returnToLocal)

-- Teleport
local function teleportToPlayer(targetName)
	local target = Players:FindFirstChild(targetName)
	if not target or not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then return end
	local targetHRP = target.Character.HumanoidRootPart
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart", 2)
	if not hrp then return end

	hrp.CFrame = CFrame.new(targetHRP.Position + Vector3.new(0, 4, 0))
	local flash = Instance.new("Frame")
	flash.Size = UDim2.new(1, 0, 1, 0)
	flash.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	flash.BackgroundTransparency = 0.5
	flash.BorderSizePixel = 0
	flash.ZIndex = 999
	flash.Parent = screenGui
	TweenService:Create(flash, TweenInfo.new(0.4), {BackgroundTransparency = 1}):Play()
	task.delay(0.5, function() flash:Destroy() end)
end

-- Filter system
local selectedPlayers = {}
local showAll = true
local buttons = {}

local function refreshDropdown()
	for _, child in ipairs(dropdownScroll:GetChildren()) do
		if child:IsA("TextButton") then child:Destroy() end
	end

	-- Add "All" button
	local allBtn = Instance.new("TextButton")
	allBtn.Size = UDim2.new(1, -6, 0, 24)
	allBtn.Position = UDim2.new(0, 3, 0, 0)
	allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
	allBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
	allBtn.Font = Enum.Font.SourceSansBold
	allBtn.TextSize = 16
	allBtn.Text = "All"
	allBtn.BorderSizePixel = 0
	allBtn.Parent = dropdownScroll
	Instance.new("UICorner", allBtn).CornerRadius = UDim.new(0, 8)

	allBtn.MouseButton1Click:Connect(function()
		showAll = not showAll
		allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
		refreshDropdown()
	end)

	for _, p in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -6, 0, 24)
		btn.Position = UDim2.new(0, 3, 0, 0)
		btn.BackgroundColor3 = selectedPlayers[p.Name] and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
		btn.TextColor3 = Color3.fromRGB(240, 240, 240)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 16
		btn.Text = p.DisplayName
		btn.BorderSizePixel = 0
		btn.Parent = dropdownScroll
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)

		btn.MouseButton1Click:Connect(function()
			selectedPlayers[p.Name] = not selectedPlayers[p.Name]
			showAll = false
			refreshDropdown()
		end)
	end

	dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
end

Players.PlayerAdded:Connect(refreshDropdown)
Players.PlayerRemoving:Connect(refreshDropdown)
refreshDropdown()

-- Logging
local messages = {}

local function logMessage(text, displayName, username)
	table.insert(messages, {text = text, displayName = displayName, username = username})

	local visible = showAll or selectedPlayers[username]
	if not visible then return end

	local entry = Instance.new("Frame")
	entry.Size = UDim2.new(1, -10, 0, 0)
	entry.BackgroundTransparency = 1
	entry.AutomaticSize = Enum.AutomaticSize.Y
	entry.Parent = scrollFrame

	local tsLabel = Instance.new("TextLabel", entry)
	tsLabel.Size = UDim2.new(0, 50, 0, 18)
	tsLabel.BackgroundTransparency = 1
	tsLabel.Font = Enum.Font.Code
	tsLabel.TextSize = 14
	tsLabel.Text = formatTimestampUTCplus8()
	tsLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
	tsLabel.TextXAlignment = Enum.TextXAlignment.Left

	local nameBtn = Instance.new("TextButton", entry)
	nameBtn.Size = UDim2.new(0, 120, 0, 0)
	nameBtn.Position = UDim2.new(0, 54, 0, 0)
	nameBtn.BackgroundTransparency = 1
	nameBtn.AutoButtonColor = false
	nameBtn.Font = Enum.Font.SourceSansBold
	-- continue from nameBtn setup...
nameBtn.Text = displayName
nameBtn.TextColor3 = getColorForName(username)
nameBtn.TextXAlignment = Enum.TextXAlignment.Left
nameBtn.AutomaticSize = Enum.AutomaticSize.Y

-- single / triple tap for spectate + teleport
local clicks, lastClickTime = 0, 0
nameBtn.MouseButton1Click:Connect(function()
	local now = tick()
	if now - lastClickTime < 0.6 then
		clicks = clicks + 1
	else
		clicks = 1
	end
	lastClickTime = now

	if clicks == 1 then
		-- spectate
		local t = Players:FindFirstChild(username)
		if t and t.Character then
			local hum = t.Character:FindFirstChildOfClass("Humanoid")
			if hum then
				camera.CameraType = Enum.CameraType.Custom
				camera.CameraSubject = hum
				spectateLabel.Text = "Spectating: " .. t.DisplayName
			end
		end
	elseif clicks >= 3 then
		-- teleport
		clicks = 0
		teleportToPlayer(username)
	end
end)

-- message button (text area)
local msgBtn = Instance.new("TextButton", entry)
msgBtn.Size = UDim2.new(1, -160, 0, 0)
msgBtn.Position = UDim2.new(0, 174, 0, 0)
msgBtn.BackgroundTransparency = 1
msgBtn.Font = Enum.Font.SourceSans
msgBtn.TextSize = 18
msgBtn.TextWrapped = true
msgBtn.TextXAlignment = Enum.TextXAlignment.Left
msgBtn.AutomaticSize = Enum.AutomaticSize.Y
msgBtn.Text = text
msgBtn.TextColor3 = Color3.fromRGB(230, 230, 230)

msgBtn.MouseButton1Click:Connect(function()
	if setclipboard then
		pcall(function()
			setclipboard(text)
			msgBtn.TextColor3 = Color3.fromRGB(0, 255, 0)
			task.delay(0.45, function()
				if msgBtn and msgBtn.Parent then
					msgBtn.TextColor3 = Color3.fromRGB(230, 230, 230)
				end
			end)
		end)
	end
end)

-- update canvas size and new message indicator
task.defer(function()
	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
	local nearBottom = scrollFrame.CanvasPosition.Y >= layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y - 40
	if nearBottom then
		scrollFrame.CanvasPosition = Vector2.new(0, math.max(0, layout.AbsoluteContentSize.Y - scrollFrame.AbsoluteSize.Y))
	else
		showNewMsgButton()
	end
end)
end -- end logMessage

-- rebuildMessages: clears scroll and re-adds messages based on filter
local function rebuildMessages()
	-- remove all message entries
	for _, child in ipairs(scrollFrame:GetChildren()) do
		if child:IsA("Frame") then child:Destroy() end
	end
	-- re-add according to current filter
	for _, m in ipairs(messages) do
		local visible = showAll or selectedPlayers[m.username]
		if visible then
			-- reuse logMessage to create entries (but avoid duplicating messages into messages array)
			-- call a helper inner function to create UI without re-inserting into messages
			local entry = Instance.new("Frame")
			entry.Size = UDim2.new(1, -10, 0, 0)
			entry.BackgroundTransparency = 1
			entry.AutomaticSize = Enum.AutomaticSize.Y
			entry.Parent = scrollFrame

			local tsLabel = Instance.new("TextLabel", entry)
			tsLabel.Size = UDim2.new(0, 50, 0, 18)
			tsLabel.BackgroundTransparency = 1
			tsLabel.Font = Enum.Font.Code
			tsLabel.TextSize = 14
			tsLabel.Text = formatTimestampUTCplus8()
			tsLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
			tsLabel.TextXAlignment = Enum.TextXAlignment.Left

			local nameBtn = Instance.new("TextButton", entry)
			nameBtn.Size = UDim2.new(0, 120, 0, 0)
			nameBtn.Position = UDim2.new(0, 54, 0, 0)
			nameBtn.BackgroundTransparency = 1
			nameBtn.AutoButtonColor = false
			nameBtn.Font = Enum.Font.SourceSansBold
			nameBtn.TextSize = 18
			nameBtn.Text = m.displayName
			nameBtn.TextColor3 = getColorForName(m.username)
			nameBtn.TextXAlignment = Enum.TextXAlignment.Left
			nameBtn.AutomaticSize = Enum.AutomaticSize.Y

			-- clicks for spectate/teleport
			local clicks2, last2 = 0, 0
			nameBtn.MouseButton1Click:Connect(function()
				local now = tick()
				if now - last2 < 0.6 then
					clicks2 = clicks2 + 1
				else
					clicks2 = 1
				end
				last2 = now
				if clicks2 == 1 then
					spectatePlayer(m.username)
				elseif clicks2 >= 3 then
					clicks2 = 0
					teleportToPlayer(m.username)
				end
			end)

			local msgBtn2 = Instance.new("TextButton", entry)
			msgBtn2.Size = UDim2.new(1, -160, 0, 0)
			msgBtn2.Position = UDim2.new(0, 174, 0, 0)
			msgBtn2.BackgroundTransparency = 1
			msgBtn2.Font = Enum.Font.SourceSans
			msgBtn2.TextSize = 18
			msgBtn2.TextWrapped = true
			msgBtn2.TextXAlignment = Enum.TextXAlignment.Left
			msgBtn2.AutomaticSize = Enum.AutomaticSize.Y
			msgBtn2.Text = m.text
			msgBtn2.TextColor3 = Color3.fromRGB(230,230,230)
			msgBtn2.MouseButton1Click:Connect(function()
				if setclipboard then
					pcall(function()
						setclipboard(m.text)
						msgBtn2.TextColor3 = Color3.fromRGB(0,255,0)
						task.delay(0.45, function()
							if msgBtn2 and msgBtn2.Parent then msgBtn2.TextColor3 = Color3.fromRGB(230,230,230) end
						end)
					end)
				end
			end)
		end
	end

	-- update canvas size
	task.defer(function()
		scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
	end)
end

-- modify refreshDropdown to rebuild visible messages when filters change
local function refreshDropdown()
	-- same content as earlier refreshDropdown but implemented here so we can call rebuildMessages afterwards
	for _, child in ipairs(dropdownScroll:GetChildren()) do
		if child:IsA("TextButton") then child:Destroy() end
	end

	-- All button (top)
	local allBtn = Instance.new("TextButton")
	allBtn.Size = UDim2.new(1, -6, 0, 24)
	allBtn.Position = UDim2.new(0, 3, 0, 0)
	allBtn.BackgroundColor3 = showAll and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
	allBtn.TextColor3 = Color3.fromRGB(240, 240, 240)
	allBtn.Font = Enum.Font.SourceSansBold
	allBtn.TextSize = 16
	allBtn.Text = "All"
	allBtn.BorderSizePixel = 0
	allBtn.Parent = dropdownScroll
	Instance.new("UICorner", allBtn).CornerRadius = UDim.new(0, 6)

	allBtn.MouseButton1Click:Connect(function()
		showAll = not showAll
		-- reset selectedPlayers if turning All on (optional)
		if showAll then
			for k,_ in pairs(selectedPlayers) do selectedPlayers[k] = nil end
		end
		refreshDropdown() -- re-render dropdown UI
		rebuildMessages()
	end)

	-- player buttons
	for _, p in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -6, 0, 24)
		btn.Position = UDim2.new(0, 3, 0, 0)
		btn.BackgroundColor3 = selectedPlayers[p.Name] and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(60, 60, 60)
		btn.TextColor3 = Color3.fromRGB(240, 240, 240)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 16
		btn.Text = p.DisplayName
		btn.BorderSizePixel = 0
		btn.Parent = dropdownScroll
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

		btn.MouseButton1Click:Connect(function()
			selectedPlayers[p.Name] = not selectedPlayers[p.Name]
			showAll = false
			refreshDropdown()
			rebuildMessages()
		end)
	end

	dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, dropdownLayout.AbsoluteContentSize.Y + 8)
end

-- override earlier connections for player added/removed
Players.PlayerAdded:Connect(function(p)
	refreshDropdown()
end)
Players.PlayerRemoving:Connect(function(p)
	selectedPlayers[p.Name] = nil
	refreshDropdown()
	rebuildMessages()
end)

-- initial population
refreshDropdown()

-- Chat hook: store messages and log them according to filters
if TextChatService and TextChatService.MessageReceived then
	TextChatService.MessageReceived:Connect(function(msg)
		if msg and msg.Text and msg.TextSource then
			local uid = msg.TextSource.UserId
			local dn, un = "[Unknown]", "[Unknown]"
			if uid then
				local pl = Players:GetPlayerByUserId(uid)
				if pl then dn, un = pl.DisplayName, pl.Name end
			end
			table.insert(messages, {text = msg.Text, displayName = dn, username = un})
			-- only create UI if visible under current filters
			if showAll or selectedPlayers[un] then
				logMessage(msg.Text, dn, un)
			end
		end
	end)
else
	for _, p in ipairs(Players:GetPlayers()) do
		p.Chatted:Connect(function(m)
			table.insert(messages, {text = m, displayName = p.DisplayName, username = p.Name})
			if showAll or selectedPlayers[p.Name] then
				logMessage(m, p.DisplayName, p.Name)
			end
		end)
	end
	Players.PlayerAdded:Connect(function(p)
		p.Chatted:Connect(function(m)
			table.insert(messages, {text = m, displayName = p.DisplayName, username = p.Name})
			if showAll or selectedPlayers[p.Name] then
				logMessage(m, p.DisplayName, p.Name)
			end
		end)
	end)
end