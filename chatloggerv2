--========================================================--
-- Chat Logger (Updated) — Added Filters: "DM’s" and "Me"
-- All original features preserved exactly
--========================================================--

if game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("ChatLoggerGui") then
    return
end

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local gui = Instance.new("ScreenGui")
gui.Name = "ChatLoggerGui"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = PlayerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 360, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = gui

local header = Instance.new("Frame")
header.Name = "Header"
header.Size = UDim2.new(1, 0, 0, 28)
header.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
header.BorderSizePixel = 0
header.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Text = "Chat Logger"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.BackgroundTransparency = 1
title.Position = UDim2.new(0, 8, 0, 0)
title.Size = UDim2.new(0, 120, 1, 0)
title.Parent = header

-----------------------------------------------------------
-- HEADER BUTTONS (unchanged)
-----------------------------------------------------------

local returnButton = Instance.new("TextButton")
returnButton.Name = "ReturnButton"
returnButton.Size = UDim2.new(0, 40, 1, 0)
returnButton.Position = UDim2.new(1, -120, 0, 0)
returnButton.Text = "↺"
returnButton.Font = Enum.Font.SourceSansBold
returnButton.TextColor3 = Color3.new(1,1,1)
returnButton.TextSize = 20
returnButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
returnButton.BorderSizePixel = 0
returnButton.Parent = header

local dropdownButton = Instance.new("TextButton")
dropdownButton.Name = "DropdownButton"
dropdownButton.Size = UDim2.new(0, 40, 1, 0)
dropdownButton.Position = UDim2.new(1, -80, 0, 0)
dropdownButton.Text = "%"
dropdownButton.Font = Enum.Font.SourceSansBold
dropdownButton.TextColor3 = Color3.new(1,1,1)
dropdownButton.TextSize = 20
dropdownButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
dropdownButton.BorderSizePixel = 0
dropdownButton.Parent = header

local hideButton = Instance.new("TextButton")
hideButton.Name = "HideButton"
hideButton.Size = UDim2.new(0, 40, 1, 0)
hideButton.Position = UDim2.new(1, -40, 0, 0)
hideButton.Text = "v"
hideButton.Font = Enum.Font.SourceSansBold
hideButton.TextColor3 = Color3.new(1,1,1)
hideButton.TextSize = 20
hideButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
hideButton.BorderSizePixel = 0
hideButton.Parent = header

local unhideButton = Instance.new("TextButton")
unhideButton.Name = "UnhideButton"
unhideButton.Size = UDim2.new(0, 40, 0, 40)
unhideButton.Position = UDim2.new(0, 10, 0, 10)
unhideButton.Text = "^"
unhideButton.Font = Enum.Font.SourceSansBold
unhideButton.TextColor3 = Color3.new(1,1,1)
unhideButton.TextSize = 22
unhideButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
unhideButton.BorderSizePixel = 0
unhideButton.Visible = false
unhideButton.Parent = gui

-----------------------------------------------------------
-- DROPDOWN PANEL
-----------------------------------------------------------

local dropdownFrame = Instance.new("Frame")
dropdownFrame.Name = "DropdownFrame"
dropdownFrame.Size = UDim2.new(0, 120, 0, 0)
dropdownFrame.Position = UDim2.new(0, 0, 0, 28)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
dropdownFrame.BorderSizePixel = 0
dropdownFrame.ClipsDescendants = true
dropdownFrame.Parent = mainFrame

local layout = Instance.new("UIListLayout")
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = dropdownFrame

-- BUTTON: ALL
local allButton = Instance.new("TextButton")
allButton.Size = UDim2.new(1, 0, 0, 24)
allButton.Text = "All"
allButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
allButton.TextColor3 = Color3.new(1,1,1)
allButton.Font = Enum.Font.SourceSansBold
allButton.TextSize = 14
allButton.BorderSizePixel = 0
allButton.Parent = dropdownFrame

-- BUTTON: DM’s (NEW)
local dmButton = Instance.new("TextButton")
dmButton.Size = UDim2.new(1, 0, 0, 24)
dmButton.Text = "DM’s"
dmButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
dmButton.TextColor3 = Color3.new(1,1,1)
dmButton.Font = Enum.Font.SourceSansBold
dmButton.TextSize = 14
dmButton.BorderSizePixel = 0
dmButton.Parent = dropdownFrame

-- BUTTON: Me (NEW)
local meButton = Instance.new("TextButton")
meButton.Size = UDim2.new(1, 0, 0, 24)
meButton.Text = "Me"
meButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
meButton.TextColor3 = Color3.new(1,1,1)
meButton.Font = Enum.Font.SourceSansBold
meButton.TextSize = 14
meButton.BorderSizePixel = 0
meButton.Parent = dropdownFrame

-----------------------------------------------------------
-- CHAT LIST
-----------------------------------------------------------

local messageFrame = Instance.new("ScrollingFrame")
messageFrame.Name = "MessageFrame"
messageFrame.Size = UDim2.new(1, 0, 1, -28)
messageFrame.Position = UDim2.new(0, 0, 0, 28)
messageFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
messageFrame.ScrollBarThickness = 6
messageFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
messageFrame.BorderSizePixel = 0
messageFrame.Parent = mainFrame

local msgLayout = Instance.new("UIListLayout")
msgLayout.SortOrder = Enum.SortOrder.LayoutOrder
msgLayout.Parent = messageFrame

local newMsgButton = Instance.new("TextButton")
newMsgButton.Size = UDim2.new(1, 0, 0, 24)
newMsgButton.Position = UDim2.new(0,0,1,-24)
newMsgButton.Text = "New messages below ↓"
newMsgButton.Font = Enum.Font.SourceSansBold
newMsgButton.TextSize = 14
newMsgButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
newMsgButton.TextColor3 = Color3.new(1,1,1)
newMsgButton.Visible = false
newMsgButton.Parent = mainFrame

-----------------------------------------------------------
-- INTERNAL STATE
-----------------------------------------------------------

local messages = {}  
local currentFilter = "All"  
local dropdownOpen = false

-----------------------------------------------------------
-- UTILITIES
-----------------------------------------------------------

local function hashColor(name)
    local h = 0
    for i = 1, #name do
        h = (h + name:byte(i)) % 360
    end
    return Color3.fromHSV(h/360, 0.6, 1)
end

local function timestamp()
    local t = os.date("!*t")
    t.hour = t.hour + 8
    if t.hour >= 24 then t.hour = t.hour - 24 end
    local ampm = t.hour >= 12 and "PM" or "AM"
    local hour = t.hour % 12
    if hour == 0 then hour = 12 end
    return string.format("%02d:%02d %s", hour, t.min, ampm)
end

local function updateCanvas()
    task.wait()
    messageFrame.CanvasSize = UDim2.new(0, 0, 0, msgLayout.AbsoluteContentSize.Y)
end

-----------------------------------------------------------
-- RENDER MESSAGES
-----------------------------------------------------------

local function renderMessages()
    for _, c in ipairs(messageFrame:GetChildren()) do
        if c:IsA("Frame") then c:Destroy() end
    end

    for _, msg in ipairs(messages) do

        -- FILTER LOGIC
        if currentFilter == "DM" then
            if not msg.IsWhisper then continue end
            if msg.ToUserId ~= LocalPlayer.UserId then continue end
        elseif currentFilter == "Me" then
            if msg.FromUserId ~= LocalPlayer.UserId then continue end
        elseif type(currentFilter) == "number" then
            if msg.FromUserId ~= currentFilter then continue end
        end

        local item = Instance.new("Frame")
        item.Size = UDim2.new(1, -6, 0, 40)
        item.BackgroundTransparency = 1
        item.Parent = messageFrame

        local nameBtn = Instance.new("TextButton")
        nameBtn.Size = UDim2.new(0, 120, 1, 0)
        nameBtn.Text = msg.DisplayName
        nameBtn.TextColor3 = hashColor(msg.Name)
        nameBtn.Font = Enum.Font.SourceSans
        nameBtn.TextSize = 14
        nameBtn.BackgroundTransparency = 1
        nameBtn.Parent = item

        local timeLabel = Instance.new("TextLabel")
        timeLabel.Size = UDim2.new(0, 70, 1, 0)
        timeLabel.Position = UDim2.new(0, 122, 0, 0)
        timeLabel.Text = msg.Time
        timeLabel.TextColor3 = Color3.new(1,1,1)
        timeLabel.Font = Enum.Font.SourceSans
        timeLabel.TextSize = 14
        timeLabel.BackgroundTransparency = 1
        timeLabel.Parent = item

        local msgBtn = Instance.new("TextButton")
        msgBtn.Size = UDim2.new(1, -200, 1, 0)
        msgBtn.Position = UDim2.new(0, 200, 0, 0)
        msgBtn.Text = msg.Text
        msgBtn.TextWrapped = true
        msgBtn.TextColor3 = Color3.fromRGB(220,220,220)
        msgBtn.BackgroundTransparency = 1
        msgBtn.Font = Enum.Font.SourceSans
        msgBtn.TextSize = 14
        msgBtn.Parent = item
    end

    updateCanvas()
end

-----------------------------------------------------------
-- ADD A MESSAGE
-----------------------------------------------------------

local function addMessage(data)
    table.insert(messages, data)
    renderMessages()

    local scrollPos = messageFrame.CanvasPosition.Y
    local maxPos = messageFrame.CanvasSize.Y.Offset - messageFrame.AbsoluteWindowSize.Y

    if scrollPos < maxPos - 20 then
        newMsgButton.Visible = true
    end
end

-----------------------------------------------------------
-- CAPTURE CHAT (TEXT CHAT SERVICE)
-----------------------------------------------------------

if TextChatService.MessageReceived then
    TextChatService.MessageReceived:Connect(function(msg)
        if msg.TextSource then

            local isWhisper = (msg.ChatMessageType == Enum.TextChatMessageType.Whisper)

            local entry = {
                Name = msg.TextSource.Name,
                DisplayName = msg.TextSource.DisplayName,
                Text = msg.Text,
                Time = timestamp(),
                FromUserId = msg.TextSource.UserId,
                ToUserId = msg.Recipient and msg.Recipient.UserId or nil,
                IsWhisper = isWhisper
            }

            addMessage(entry)
        end
    end)
end

-----------------------------------------------------------
-- FILTER BUTTON LOGIC
-----------------------------------------------------------

allButton.MouseButton1Click:Connect(function()
    currentFilter = "All"
    renderMessages()
end)

dmButton.MouseButton1Click:Connect(function()
    currentFilter = "DM"
    renderMessages()
end)

meButton.MouseButton1Click:Connect(function()
    currentFilter = "Me"
    renderMessages()
end)

-----------------------------------------------------------
-- HIDE / UNHIDE
-----------------------------------------------------------

hideButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    unhideButton.Visible = true
end)

unhideButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = true
    unhideButton.Visible = false
end)

-----------------------------------------------------------
-- TOGGLE DROPDOWN
-----------------------------------------------------------

dropdownButton.MouseButton1Click:Connect(function()
    dropdownOpen = not dropdownOpen
    dropdownFrame:TweenSize(
        dropdownOpen and UDim2.new(0, 120, 0, dropdownFrame.UIListLayout.AbsoluteContentSize.Y) or UDim2.new(0, 120, 0, 0),
        Enum.EasingDirection.Out,
        Enum.EasingStyle.Quad,
        0.25,
        true
    )
end)

-----------------------------------------------------------
-- RESET CAMERA
-----------------------------------------------------------

returnButton.MouseButton1Click:Connect(function()
    workspace.CurrentCamera.CameraSubject = LocalPlayer.Character:FindFirstChild("Humanoid")
end)

-----------------------------------------------------------
-- SCROLL TO NEW MESSAGES
-----------------------------------------------------------

newMsgButton.MouseButton1Click:Connect(function()
    messageFrame.CanvasPosition = Vector2.new(0, messageFrame.CanvasSize.Y.Offset)
    newMsgButton.Visible = false
end)

-----------------------------------------------------------
-- DONE
-----------------------------------------------------------

print("Chat Logger loaded — DM’s filter, Me filter added.")
