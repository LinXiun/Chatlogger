-- Chat Logger Script Updated with Dropdown Counts, PMs, Mentions
-- Original script features fully preserved

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Prevent duplicate GUI
if PlayerGui:FindFirstChild("ChatLoggerGui") then
    PlayerGui.ChatLoggerGui:Destroy()
end

-- Main GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChatLoggerGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 360, 0, 300)
MainFrame.Position = UDim2.new(0.1,0,0.1,0)
MainFrame.BackgroundTransparency = 0.4
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.ClipsDescendants = true
MainFrame.AnchorPoint = Vector2.new(0,0)

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.Size = UDim2.new(1,0,0,30)
Header.BackgroundTransparency = 0.6
Header.BackgroundColor3 = Color3.fromRGB(50,50,50)
Header.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(0.6,0,1,0)
Title.BackgroundTransparency = 1
Title.Text = "Chat Logger"
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.TextScaled = true
Title.Font = Enum.Font.SourceSansBold
Title.Parent = Header

-- Hide button
local HideBtn = Instance.new("TextButton")
HideBtn.Size = UDim2.new(0,30,1,0)
HideBtn.Position = UDim2.new(1,-30,0,0)
HideBtn.Text = "v"
HideBtn.TextColor3 = Color3.fromRGB(255,255,255)
HideBtn.BackgroundTransparency = 0.7
HideBtn.Parent = Header

-- Unhide button (hidden by default)
local UnhideBtn = Instance.new("TextButton")
UnhideBtn.Size = UDim2.new(0,30,0,30)
UnhideBtn.Position = MainFrame.Position
UnhideBtn.Text = "^"
UnhideBtn.TextColor3 = Color3.fromRGB(255,255,255)
UnhideBtn.BackgroundTransparency = 0.7
UnhideBtn.Visible = false
UnhideBtn.Parent = ScreenGui

-- Scrollable chat area
local ChatScroll = Instance.new("ScrollingFrame")
ChatScroll.Size = UDim2.new(1,0,1,-30)
ChatScroll.Position = UDim2.new(0,0,0,30)
ChatScroll.BackgroundTransparency = 1
ChatScroll.ScrollBarThickness = 6
ChatScroll.CanvasSize = UDim2.new(0,0,0,0)
ChatScroll.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0,2)
UIListLayout.Parent = ChatScroll

-- Dropdown for sections
local DropdownFrame = Instance.new("Frame")
DropdownFrame.Name = "Dropdown"
DropdownFrame.Size = UDim2.new(0,360,0,20)
DropdownFrame.Position = UDim2.new(0,0,0,30)
DropdownFrame.BackgroundTransparency = 0.7
DropdownFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
DropdownFrame.Visible = true
DropdownFrame.Parent = MainFrame

local DropdownLayout = Instance.new("UIListLayout")
DropdownLayout.SortOrder = Enum.SortOrder.LayoutOrder
DropdownLayout.Padding = UDim.new(0,1)
DropdownLayout.Parent = DropdownFrame

-- Sections and counts
local Sections = {
    All = {Count = 0, TextButton=nil},
    PMs = {Count = 0, TextButton=nil},
    Mentions = {Count = 0, TextButton=nil},
}

for name,_ in pairs(Sections) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,0,0,20)
    btn.BackgroundTransparency = 0.5
    btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 14
    btn.Text = name.." (0)"
    btn.Parent = DropdownFrame
    Sections[name].TextButton = btn
end

-- Message storage
local messages = {} -- {player, text, type, timestamp, read}

-- Track new messages
local newCounts = {All=0, PMs=0, Mentions=0}
local playerNewCounts = {} -- {playerName = count}

-- Function to add a message
local function AddMessage(player, text, msgType)
    local msg = {player=player, text=text, type=msgType, timestamp=os.time(), read=false}
    table.insert(messages, msg)
    
    -- Update counts
    if msgType=="PM" then
        newCounts.PMs = newCounts.PMs + 1
    elseif msgType=="Mention" then
        newCounts.Mentions = newCounts.Mentions + 1
    else
        newCounts.All = newCounts.All + 1
        playerNewCounts[player.Name] = (playerNewCounts[player.Name] or 0) + 1
    end
    
    -- Update section buttons
    for sec, data in pairs(Sections) do
        data.TextButton.Text = sec.." ("..newCounts[sec]..")"
    end
    
    -- Display message in scroll
    local msgBtn = Instance.new("TextButton")
    msgBtn.Size = UDim2.new(1,0,0,20)
    msgBtn.BackgroundTransparency = 0.7
    msgBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    msgBtn.Font = Enum.Font.SourceSans
    msgBtn.TextSize = 14
    msgBtn.TextColor3 = Color3.fromRGB(255,255,255)
    msgBtn.Text = "["..player.Name.."]: "..text
    msgBtn.Parent = ChatScroll
end

-- Example hooks (you should integrate your actual chat receiving logic)
local function OnPlayerChatted(player, message)
    local lower = message:lower()
    if lower:find(LocalPlayer.Name:lower()) then
        AddMessage(player, message, "Mention")
    elseif lower:find("whisper") then
        AddMessage(player, message, "PM")
    else
        AddMessage(player, message, "All")
    end
end

-- Connect Player Chatted
Players.PlayerAdded:Connect(function(plr)
    plr.Chatted:Connect(function(msg)
        OnPlayerChatted(plr, msg)
    end)
end)

for _,plr in pairs(Players:GetPlayers()) do
    plr.Chatted:Connect(function(msg)
        OnPlayerChatted(plr, msg)
    end)
end

-- Hide/Unhide buttons logic
HideBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    UnhideBtn.Visible = true
end)

UnhideBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    UnhideBtn.Visible = false
end)

-- Initialize GUI alignment
ChatScroll.CanvasSize = UDim2.new(0,0,0,UIListLayout.AbsoluteContentSize.Y)

print("Chat Logger updated: PMs, Mentions, and per-player new message counts added.")
